<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Voice Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e1e5e9;
            z-index: 1000;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tabbar-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .tabbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            text-decoration: none;
        }

        .tabbar-nav {
            display: flex;
            gap: 5px;
        }

        .tabbar-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            color: #7f8c8d;
            background: transparent;
        }

        .tabbar-link:hover {
            color: #2c3e50;
            background: rgba(102, 126, 234, 0.1);
        }

        .tabbar-link.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        .tabbar-link .icon {
            font-size: 1.1rem;
        }

        .main-content {
            margin-top: 90px;
            padding-top: 20px;
            min-height: calc(100vh - 90px);
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .tabbar-container {
                padding: 0 15px;
                height: 60px;
            }
            
            .tabbar-brand {
                font-size: 1rem;
            }
            
            .tabbar-link {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .tabbar-link .icon {
                font-size: 1rem;
            }
            
            .main-content {
                margin-top: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .tabbar-container {
                padding: 0 10px;
                height: 55px;
            }
            
            .tabbar-link {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .main-content {
                margin-top: 75px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .dashboard-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .contacts-table-header,
            .sequences-table-header,
            .phone-numbers-table-header {
                padding: 12px 16px;
                font-size: 0.8rem;
            }
            
            .contact-row,
            .sequence-row,
            .phone-number-row {
                padding: 12px 16px;
                font-size: 0.85rem;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
        }
        
        .status-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .status-value {
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }
        
        /* CRM Status Indicators */
        .status-active {
            background: #d4edda;
            color: #155724;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-do-not-call {
            background: #e2e3e5;
            color: #6c757d;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .call-section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e1e5e9;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .call-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .call-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .call-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .call-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .stats-section {
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        /* Dashboard specific styles */
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .dashboard-title {
            font-size: 2em;
            color: #2c3e50;
            font-weight: 700;
            margin: 0;
        }
        
        .dashboard-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid #e1e5e9;
        }
        
        .filters-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid #e1e5e9;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-range-inputs input {
            flex: 1;
        }
        
        .date-separator {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .filter-actions .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Search Styles */
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Pagination Styles */
        .calls-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            font-weight: 600;
            color: #333;
        }
        
        .calls-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .calls-count {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }
        
        .calls-header-right {
            display: flex;
            align-items: center;
        }
        
        .pagination-info {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e1e5e9;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .page-number:hover {
            background: #f8f9fa;
        }
        
        .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-number.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .calls-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .calls-table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            font-weight: 600;
            color: #333;
        }
        
        .calls-table-content {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Chart Styles */
        .charts-section {
            margin: 30px 0;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-container h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 250px !important;
        }
        
        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        
        .call-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .call-row:hover {
            background: #f8f9fa;
        }
        
        .call-row:last-child {
            border-bottom: none;
        }
        
        .call-phone {
            font-weight: 600;
            color: #333;
        }
        
        .call-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .call-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-align: center;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-answered {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unanswered {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-in-progress {
            background: #fff3cd;
            color: #856404;
        }
        
        .call-duration {
            color: #666;
            font-size: 0.9em;
        }
        
        .call-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        /* Agent Assignment Styles */
        .agent-assignment-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .assignment-header h4 {
            margin: 0 0 5px 0;
            color: #495057;
        }

        .assignment-header p {
            margin: 0 0 15px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .assignment-mode {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .assignment-mode label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .assignment-mode-content {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .weight-input {
            width: 80px;
            margin-left: 10px;
        }

        .agent-item {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .agent-item .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agent-item label {
            min-width: 60px;
            margin-bottom: 0;
        }

        /* Sequence Tabs Styles */
        .sequence-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .sequence-tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .sequence-tab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .sequence-tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .sequence-tab-content {
            display: none;
        }

        .sequence-tab-content.active {
            display: block;
        }

        /* Beta Test Section Styles */
        .beta-test-section {
            padding: 20px 0;
        }

        .beta-test-header h4 {
            margin: 0 0 5px 0;
            color: #495057;
        }

        .beta-test-header p {
            margin: 0 0 20px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .date-filters {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .date-filters .form-group {
            margin-bottom: 0;
        }

        .date-filters .form-input {
            width: 150px;
        }

        .beta-metrics-table {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .beta-metrics-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }

        .beta-metrics-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
        }

        .beta-metrics-row:last-child {
            border-bottom: none;
        }

        .beta-metrics-row:hover {
            background: #f8f9fa;
        }

        .agent-name {
            font-weight: 500;
            color: #495057;
        }

        .metric-value {
            text-align: center;
            font-weight: 600;
        }

        .metric-value.positive {
            color: #28a745;
        }

        .metric-value.neutral {
            color: #6c757d;
        }

        .metric-value.negative {
            color: #dc3545;
        }

        /* Agent Configuration Section Styles */
        .agent-config-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .agent-config-section h4 {
            margin: 0 0 5px 0;
            color: #495057;
        }

        .section-description {
            margin: 0 0 15px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .sequence-agent-item {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .sequence-agent-item .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sequence-agent-item label {
            min-width: 60px;
            margin-bottom: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Settings Tab Styles */
        .settings-content {
            max-width: 800px;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e1e5e9;
        }

        .settings-section h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 1.3em;
        }

        .settings-description {
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .phone-pool-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .current-pool h4,
        .add-phone-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
        }

        .phone-pool-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
        }

        .phone-pool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .phone-pool-item:last-child {
            margin-bottom: 0;
        }

        .phone-id {
            font-weight: 500;
            color: #495057;
        }

        .remove-phone {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .remove-phone:hover {
            background: #c82333;
        }

        .add-phone-section .form-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .add-phone-section .form-input {
            flex: 1;
        }

        .add-phone-section .btn {
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .phone-pool-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        /* Contacts and Sequences Table Styles */
        .contacts-table,
        .sequences-table,
        .phone-numbers-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid #e1e5e9;
        }
        
        .contacts-table-header,
        .sequences-table-header,
        .phone-numbers-table-header {
            display: grid;
            gap: 15px;
            padding: 18px 24px;
            background: #f8f9fa;
            border-bottom: 2px solid #e1e5e9;
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-items: center;
        }

        .table-header-cell {
            display: flex;
            align-items: center;
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 24px;
        }
        
        .contacts-table-header {
            grid-template-columns: 2fr 2fr 1.5fr 1.5fr 2fr 1fr 1fr;
        }
        
        .sequences-table-header {
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr 1fr;
        }
        
        .phone-numbers-table-header {
            grid-template-columns: 2fr 1fr 2fr 1.5fr 1fr 1fr 1fr;
        }
        
        .contacts-table-content,
        .sequences-table-content,
        .phone-numbers-table-content {
            max-height: 600px;
            overflow-y: auto;
            background: white;
        }
        
        .contact-row,
        .sequence-row,
        .phone-number-row {
            display: grid;
            gap: 15px;
            padding: 18px 24px;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        /* Ensure all data cells have consistent alignment */
        .contact-row > div,
        .sequence-row > div,
        .phone-number-row > div {
            display: flex;
            align-items: center;
            min-height: 24px;
        }
        
        .contact-row {
            grid-template-columns: 2fr 2fr 1.5fr 1.5fr 2fr 1fr 1fr;
        }
        
        .sequence-row {
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr 1fr;
        }
        
        .phone-number-row {
            grid-template-columns: 2fr 1fr 2fr 1.5fr 1fr 1fr 1fr;
        }
        
        .contact-row:hover,
        .sequence-row:hover,
        .phone-number-row:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .contact-row:last-child,
        .sequence-row:last-child,
        .phone-number-row:last-child {
            border-bottom: none;
        }
        
        .contact-name {
            font-weight: 600;
            color: #333;
        }
        
        .contact-email {
            color: #007bff;
            text-decoration: none;
        }
        
        .contact-email:hover {
            text-decoration: underline;
        }
        
        .contact-company {
            color: #666;
            font-size: 0.9em;
        }
        
        .contact-position {
            color: #666;
            font-size: 0.9em;
        }
        
        .contact-phones {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .phone-number {
            font-size: 0.9em;
            color: #333;
        }
        
        .phone-type {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        
        .contact-status,
        .sequence-status {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 20px;
        }
        
        
        
        .contact-actions,
        .sequence-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: flex-start;
        }
        
        .btn-edit {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        .btn-edit:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .sequence-name {
            font-weight: 600;
            color: #333;
        }
        
        .sequence-description {
            color: #666;
            font-size: 0.9em;
        }
        
        .sequence-entries {
            color: #007bff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Sequence Management Styles */
        .sequence-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress-section h5 {
            margin-bottom: 10px;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .sequence-actions-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .queue-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-item {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 2fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f1f3f4;
            align-items: center;
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-phone {
            font-weight: 600;
            color: #333;
        }

        .queue-contact {
            color: #666;
        }

        .queue-attempt {
            color: #007bff;
            font-weight: 600;
        }

        .queue-time {
            color: #666;
            font-size: 0.9em;
        }

        /* Upload Modal Styles */
        .upload-section {
            padding: 20px 0;
        }

        .csv-format-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .csv-format-info h4 {
            margin-top: 0;
            color: #333;
        }

        .format-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .format-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .format-item ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .format-item li {
            margin-bottom: 5px;
            color: #666;
        }

        .upload-options {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        #sequence-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }

        .file-upload-area {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            background: #fafafa;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .upload-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
        }

        .upload-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .upload-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Ensure upload modal is above tabbar */
        #uploadModal {
            z-index: 3000;
        }

        #uploadModal .modal-content {
            z-index: 3001;
        }

        /* Ensure all modals are above tabbar */
        .modal {
            z-index: 3000 !important;
        }

        .modal-content {
            z-index: 3001 !important;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .call-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Tabbar -->
    <nav class="tabbar">
        <div class="tabbar-container">
            <a href="/" class="tabbar-brand">
                <span class="icon">ü§ñ</span>
                AI Voice Agent
            </a>
            <div class="tabbar-nav">
                <a href="/" class="tabbar-link active" data-tab="main">
                    <span class="icon">üè†</span>
                    Dashboard
                </a>
                <a href="#" class="tabbar-link" data-tab="calls">
                    <span class="icon">üìû</span>
                    Call History
                </a>
                <a href="#" class="tabbar-link" data-tab="contacts">
                    <span class="icon">üë•</span>
                    Contacts
                </a>
                <a href="#" class="tabbar-link" data-tab="sequences">
                    <span class="icon">üîÑ</span>
                    Sequences
                </a>
                <a href="#" class="tabbar-link" data-tab="phone-numbers">
                    <span class="icon">üì±</span>
                    Phone Numbers
                </a>
                <a href="#" class="tabbar-link" data-tab="settings">
                    <span class="icon">‚öôÔ∏è</span>
                    Settings
                </a>
                <a href="#" class="tabbar-link" data-tab="analytics">
                    <span class="icon">üìä</span>
                    Analytics
                </a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <!-- Main Dashboard Tab -->
            <div class="dashboard-content active" id="main-tab">
                <div class="header">
                    <h1>üéØ ElevenLabs Voice Agent</h1>
                    <p>ElevenLabs Conversational AI Dashboard</p>
                </div>
                
                <div class="status-section">
                    <h3 style="margin-bottom: 15px; color: #333;">System Status</h3>
                    <div class="status-item">
                        <span class="status-label">Server</span>
                        <span class="status-value status-unknown" id="server-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ElevenLabs</span>
                        <span class="status-value status-unknown" id="elevenlabs-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Agent</span>
                        <span class="status-value status-unknown" id="agent-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ELEVENLABS_API_KEY</span>
                        <span class="status-value status-unknown" id="api-key-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ELEVENLABS_AGENT_ID</span>
                        <span class="status-value status-unknown" id="agent-id-status">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ELEVENLABS_PHONE_NUMBER_ID</span>
                        <span class="status-value status-unknown" id="phone-id-status">Checking...</span>
                    </div>
                <div class="status-item">
                    <span class="status-label">Batch Caller</span>
                    <span class="status-value status-unknown" id="batch-caller-status">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Batch Caller Details</span>
                    <span class="status-value status-unknown" id="batch-caller-details">Checking...</span>
                </div>
                </div>
                
                <div class="call-section">
                    <h3 style="margin-bottom: 20px; color: #333;">Make ElevenLabs Voice Call</h3>
                    <form id="call-form">
                        <div class="form-group">
                            <label for="phone-number">Phone Number</label>
                            <input 
                                type="tel" 
                                id="phone-number" 
                                name="phoneNumber" 
                                placeholder="+1234567890" 
                                required
                                pattern="^\+[1-9]\d{1,14}$"
                                title="Please enter a valid international phone number (e.g., +1234567890)"
                            >
                            <small style="color: #666; font-size: 0.9em;">Enter in international format (e.g., +1234567890)</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="call-btn">
                            üéØ Start ElevenLabs Call
                        </button>
                        <button type="button" class="btn btn-secondary" id="refresh-btn">
                            üîÑ Refresh Status
                        </button>
                    </form>
                    
                    <div class="call-status" id="call-status">
                        <div id="call-message"></div>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3 style="margin-bottom: 15px; color: #333;">Live Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="active-calls">0</div>
                            <div class="stat-label">Active Calls</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="ai-conversations">0</div>
                            <div class="stat-label">AI Conversations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="play-streams">0</div>
                            <div class="stat-label">ElevenLabs Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call History Tab -->
            <div class="dashboard-content" id="calls-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">üìû Call History</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-secondary" id="refresh-calls-btn">
                            üîÑ Refresh Calls
                        </button>
                        <button class="btn btn-primary" id="sync-calls-btn">
                            üîÑ Sync from ElevenLabs
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 style="margin-bottom: 15px; color: #333;">Advanced Filters</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="filter-call-result">Call Result</label>
                            <select id="filter-call-result">
                                <option value="">All Results</option>
                                <option value="answered">Answered</option>
                                <option value="failed">Failed</option>
                                <option value="unanswered">Unanswered</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-date-start">Date Range</label>
                            <div class="date-range-inputs">
                                <input type="date" id="filter-date-start" placeholder="Start Date">
                                <span class="date-separator">to</span>
                                <input type="date" id="filter-date-end" placeholder="End Date">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filter-phone">Phone Number</label>
                            <input type="text" id="filter-phone" placeholder="Search phone number...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-meeting">Meeting Booked</label>
                            <select id="filter-meeting">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-interested">Person Interested</label>
                            <select id="filter-interested">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-upset">Person Very Upset</label>
                            <select id="filter-upset">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-duration">Duration (minutes)</label>
                            <select id="filter-duration">
                                <option value="">All Durations</option>
                                <option value="0-1">0-1 minute</option>
                                <option value="1-5">1-5 minutes</option>
                                <option value="5-10">5-10 minutes</option>
                                <option value="10+">10+ minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" id="apply-filters-btn">Apply Filters</button>
                        <button class="btn btn-secondary" id="clear-filters-btn">Clear All</button>
                    </div>
                </div>

                <div class="search-section">
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="Search calls by phone number, status, or any text..." class="search-input">
                        <button class="btn btn-primary" id="search-btn">üîç Search</button>
                    </div>
                </div>

                <div class="calls-table">
                    <div class="calls-table-header">
                        <div class="calls-header-left">
                            <span>Recent Calls</span>
                            <span class="calls-count" id="calls-count">(0 calls)</span>
                        </div>
                        <div class="calls-header-right">
                            <span class="pagination-info" id="pagination-info">Showing 0-0 of 0</span>
                        </div>
                    </div>
                    <div class="calls-table-content" id="calls-table-content">
                        <div class="loading">Loading calls...</div>
                    </div>
                    <div class="pagination-controls" id="pagination-controls" style="display: none;">
                        <button class="btn btn-secondary" id="prev-page-btn">‚Üê Previous</button>
                        <div class="page-numbers" id="page-numbers"></div>
                        <button class="btn btn-secondary" id="next-page-btn">Next ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="dashboard-content" id="settings-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">‚öôÔ∏è Settings</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-secondary" id="save-settings-btn">üíæ Save Settings</button>
                        <button class="btn btn-secondary" id="refresh-settings-btn">üîÑ Refresh</button>
                    </div>
                </div>

                <div class="settings-content">
                    <!-- Phone Pool Configuration -->
                    <div class="settings-section">
                        <h3>üì± Phone Number Pool</h3>
                        <p class="settings-description">
                            Configure phone numbers for randomization to avoid spam filters.
                            Each call will randomly select from this pool.
                        </p>

                        <div class="phone-pool-section">
                            <div class="current-pool">
                                <h4>Current Phone Pool:</h4>
                                <div id="current-phone-pool" class="phone-pool-list">
                                    <div class="loading">Loading phone pool...</div>
                                </div>
                            </div>

                            <div class="add-phone-section">
                                <h4>Add Phone Number:</h4>
                                <div class="form-group">
                                    <input type="text" id="new-phone-id" placeholder="e.g., phnum_001" class="form-input">
                                    <button type="button" id="add-phone-btn" class="btn btn-primary">‚ûï Add Phone</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Settings Sections (placeholder) -->
                    <div class="settings-section">
                        <h3>üéØ Agent Configuration</h3>
                        <p class="settings-description">
                            Default agent settings (display only). Sequence-level settings override these.
                        </p>

                        <div class="form-group">
                            <label for="default-agent-id">Default Agent ID:</label>
                            <input type="text" id="default-agent-id" placeholder="e.g., agent_default" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="default-agent-phone">Default Phone ID:</label>
                            <input type="text" id="default-agent-phone" placeholder="e.g., phnum_default" class="form-input">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="dashboard-content" id="analytics-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">üìä Analytics Dashboard</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-secondary" id="refresh-analytics-btn">
                            üîÑ Refresh Analytics
                        </button>
                    </div>
                </div>

                <div class="stats-section">
                    <h3 style="margin-bottom: 15px; color: #333;">Call Analytics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="total-calls">0</div>
                            <div class="stat-label">Total Calls</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="success-rate">0%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="avg-duration">0m</div>
                            <div class="stat-label">Avg Duration</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="meetings-booked">0</div>
                            <div class="stat-label">Meetings Booked</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Analytics Charts -->
                <div class="charts-section">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>üìà Daily Call Volume</h4>
                            <canvas id="dailyCallsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>üìä Success Rate Trends</h4>
                            <canvas id="successRateChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>‚è±Ô∏è Average Call Duration</h4>
                            <canvas id="durationChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>üïê Hourly Distribution</h4>
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>üìû Call Status Breakdown</h4>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>‚è∞ Duration Distribution</h4>
                            <canvas id="durationDistributionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container full-width">
                            <h4>üì± Top Phone Numbers</h4>
                            <canvas id="phoneNumbersChart"></canvas>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Contacts Tab -->
            <div class="dashboard-content" id="contacts-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">üë• Contacts Management</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-primary" id="add-contact-btn">
                            ‚ûï Add Contact
                        </button>
                        <button class="btn btn-success" id="upload-contacts-btn">
                            üìÅ Upload CSV
                        </button>
                        <button class="btn btn-secondary" id="refresh-contacts-btn">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <!-- Contact Filters -->
                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="contact-name-filter">Name</label>
                            <input type="text" id="contact-name-filter" placeholder="Search by name...">
                        </div>
                        <div class="filter-group">
                            <label for="contact-email-filter">Email</label>
                            <input type="email" id="contact-email-filter" placeholder="Search by email...">
                        </div>
                        <div class="filter-group">
                            <label for="contact-company-filter">Company</label>
                            <input type="text" id="contact-company-filter" placeholder="Search by company...">
                        </div>
                        <div class="filter-group">
                            <label for="contact-status-filter">Status</label>
                            <select id="contact-status-filter">
                                <option value="">All</option>
                                <option value="false">Active</option>
                                <option value="true">Do Not Call</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contacts Table -->
                <div class="contacts-table">
                    <div class="contacts-table-header">
                        <div class="table-header-cell">Name</div>
                        <div class="table-header-cell">Email</div>
                        <div class="table-header-cell">Company</div>
                        <div class="table-header-cell">Position</div>
                        <div class="table-header-cell">Phone Numbers</div>
                        <div class="table-header-cell">Status</div>
                        <div class="table-header-cell">Actions</div>
                    </div>
                    <div class="contacts-table-content" id="contacts-table-content">
                        <div class="loading">Loading contacts...</div>
                    </div>
                </div>

                <!-- Contact Pagination -->
                <div class="pagination-controls" id="contacts-pagination-controls" style="display: none;">
                    <button class="btn btn-secondary" id="contacts-prev-page-btn">‚Üê Previous</button>
                    <div class="page-numbers" id="contacts-page-numbers"></div>
                    <button class="btn btn-secondary" id="contacts-next-page-btn">Next ‚Üí</button>
                </div>
            </div>

            <!-- Sequences Tab -->
            <div class="dashboard-content" id="sequences-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">üîÑ Sequence Management</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-primary" id="add-sequence-btn">
                            ‚ûï Add Sequence
                        </button>
                        <button class="btn btn-secondary" id="refresh-sequences-btn">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <!-- Sequence Filters -->
                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="sequence-name-filter">Name</label>
                            <input type="text" id="sequence-name-filter" placeholder="Search by name...">
                        </div>
                        <div class="filter-group">
                            <label for="sequence-status-filter">Status</label>
                            <select id="sequence-status-filter">
                                <option value="">All</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sequences Table -->
                <div class="sequences-table">
                    <div class="sequences-table-header">
                        <div class="table-header-cell">Name</div>
                        <div class="table-header-cell">Description</div>
                        <div class="table-header-cell">Max Attempts</div>
                        <div class="table-header-cell">Retry Delay</div>
                        <div class="table-header-cell">Status</div>
                        <div class="table-header-cell">Entries</div>
                        <div class="table-header-cell">Actions</div>
                    </div>
                    <div class="sequences-table-content" id="sequences-table-content">
                        <div class="loading">Loading sequences...</div>
                    </div>
                </div>

                <!-- Sequence Pagination -->
                <div class="pagination-controls" id="sequences-pagination-controls" style="display: none;">
                    <button class="btn btn-secondary" id="sequences-prev-page-btn">‚Üê Previous</button>
                    <div class="page-numbers" id="sequences-page-numbers"></div>
                    <button class="btn btn-secondary" id="sequences-next-page-btn">Next ‚Üí</button>
                </div>
            </div>

            <!-- Phone Numbers Tab -->
            <div class="dashboard-content" id="phone-numbers-tab">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">üì± Phone Numbers Management</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-primary" id="add-phone-number-btn">
                            ‚ûï Add Phone Number
                        </button>
                        <button class="btn btn-secondary" id="refresh-phone-numbers-btn">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <!-- Phone Number Filters -->
                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="phone-number-filter">Phone Number</label>
                            <input type="text" id="phone-number-filter" placeholder="Search by phone number...">
                        </div>
                        <div class="filter-group">
                            <label for="phone-type-filter">Type</label>
                            <select id="phone-type-filter">
                                <option value="">All</option>
                                <option value="mobile">Mobile</option>
                                <option value="home">Home</option>
                                <option value="work">Work</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="phone-status-filter">Status</label>
                            <select id="phone-status-filter">
                                <option value="">All</option>
                                <option value="false">Active</option>
                                <option value="true">Do Not Call</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Phone Numbers Table -->
                <div class="phone-numbers-table">
                    <div class="phone-numbers-table-header">
                        <div class="table-header-cell">Phone Number</div>
                        <div class="table-header-cell">Type</div>
                        <div class="table-header-cell">Contact</div>
                        <div class="table-header-cell">Company</div>
                        <div class="table-header-cell">Status</div>
                        <div class="table-header-cell">Calls</div>
                        <div class="table-header-cell">Actions</div>
                    </div>
                    <div class="phone-numbers-table-content" id="phone-numbers-table-content">
                        <div class="loading">Loading phone numbers...</div>
                    </div>
                </div>

                <!-- Phone Numbers Pagination -->
                <div class="pagination-controls" id="phone-numbers-pagination-controls" style="display: none;">
                    <button class="btn btn-secondary" id="phone-numbers-prev-page-btn">‚Üê Previous</button>
                    <div class="page-numbers" id="phone-numbers-page-numbers"></div>
                    <button class="btn btn-secondary" id="phone-numbers-next-page-btn">Next ‚Üí</button>
                </div>
            </div>
            </div>
</div>

<!-- Sequence Modal -->
<div id="sequenceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="sequenceModalTitle">Add Sequence</h3>
            <span class="close" onclick="closeSequenceModal()">&times;</span>
        </div>
        <div class="modal-body" id="sequenceContent">
            <form id="sequenceForm">
                <div class="form-group">
                    <label for="sequenceName">Name *</label>
                    <input type="text" id="sequenceName" required>
                </div>
                <div class="form-group">
                    <label for="sequenceDescription">Description</label>
                    <textarea id="sequenceDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sequenceMaxAttempts">Max Attempts</label>
                        <input type="number" id="sequenceMaxAttempts" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="sequenceRetryDelay">Retry Delay (hours)</label>
                        <input type="number" id="sequenceRetryDelay" value="24" min="1" max="168">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sequenceIsActive" checked>
                        Active
                    </label>
                </div>
                
                <!-- Business Hours Section -->
                <div class="business-hours-section">
                    <h4>Business Hours Configuration</h4>
                    <div class="form-group">
                        <label for="sequenceTimezone">Timezone</label>
                        <select id="sequenceTimezone" required>
                            <option value="UTC">UTC (Coordinated Universal Time)</option>
                            <option value="America/New_York">Eastern Time (ET)</option>
                            <option value="America/Chicago">Central Time (CT)</option>
                            <option value="America/Denver">Mountain Time (MT)</option>
                            <option value="America/Los_Angeles">Pacific Time (PT)</option>
                            <option value="Europe/London">London (GMT/BST)</option>
                            <option value="Europe/Paris">Paris (CET/CEST)</option>
                            <option value="Europe/Berlin">Berlin (CET/CEST)</option>
                            <option value="Asia/Tokyo">Tokyo (JST)</option>
                            <option value="Asia/Shanghai">Shanghai (CST)</option>
                            <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
                            <option value="Pacific/Auckland">Auckland (NZST/NZDT)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sequenceBusinessHoursStart">Start Time</label>
                            <input type="time" id="sequenceBusinessHoursStart" value="09:00" required>
                        </div>
                        <div class="form-group">
                            <label for="sequenceBusinessHoursEnd">End Time</label>
                            <input type="time" id="sequenceBusinessHoursEnd" value="17:00" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="sequenceExcludeWeekends" checked>
                            Exclude Weekends (Saturdays and Sundays)
                        </label>
                    </div>
                    <div class="business-hours-preview">
                        <div id="businessHoursPreview" class="preview-text">Business Hours: 09:00 - 17:00 UTC (excluding weekends)</div>
                        <div id="businessHoursValidation" class="validation-message"></div>
                    </div>
                </div>

                <!-- Agent Assignment Configuration -->
                <div class="agent-config-section">
                    <h4>ü§ñ Agent Assignment Configuration (Beta Testing)</h4>
                    <p class="section-description">Configure how agents are automatically assigned when phone numbers are added to this sequence.</p>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableAgentConfig">
                            Enable Agent Assignment
                        </label>
                    </div>

                    <div id="agentConfigContainer" style="display: none;">
                        <div class="assignment-mode">
                            <label><input type="radio" name="sequenceAssignmentMode" value="single" checked> Single Agent</label>
                            <label><input type="radio" name="sequenceAssignmentMode" value="distribute"> Distribute Agents</label>
                        </div>

                        <!-- Single Agent Mode -->
                        <div id="sequenceSingleAgentMode" class="assignment-mode-content">
                            <div class="form-group">
                                <label for="sequenceSingleAgentId">Agent ID: *</label>
                                <input type="text" id="sequenceSingleAgentId" placeholder="e.g., agent_01jzr5hv9eefkbmnyz8y6smw19" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="sequenceSingleAgentPhone">Phone Number ID: (Optional)</label>
                                <input type="text" id="sequenceSingleAgentPhone" placeholder="e.g., phnum_0101k1tg02tkf5paw24vvbtwrmr2 (leave empty to use global pool)" class="form-input">
                                <small style="color: #6c757d; font-size: 12px;">Leave empty to use random phone from global pool</small>
                            </div>
                        </div>

                        <!-- Distribute Agents Mode -->
                        <div id="sequenceDistributeAgentsMode" class="assignment-mode-content" style="display: none;">
                            <div class="sequence-agent-list" id="sequenceAgentList">
                                <div class="sequence-agent-item">
                                    <div class="form-group">
                                        <label>Agent 1</label>
                                        <input type="text" class="sequence-agent-id" placeholder="Agent ID *" class="form-input" required>
                                        <input type="text" class="sequence-agent-phone" placeholder="Phone ID (optional)" class="form-input">
                                        <input type="number" class="sequence-agent-weight" placeholder="Weight" value="1" min="1" class="form-input weight-input">
                                        <button type="button" class="btn btn-small btn-danger remove-sequence-agent">Remove</button>
                                    </div>
                                    <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">Leave phone ID empty to use random phone from global pool</small>
                                </div>
                            </div>
                            <button type="button" id="addSequenceAgentBtn" class="btn btn-secondary">‚ûï Add Agent</button>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Sequence</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSequenceModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sequence Details Modal -->
<div id="sequenceDetailsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="sequenceDetailsModalTitle">Sequence Details</h3>
            <span class="close" onclick="closeSequenceDetailsModal()">&times;</span>
        </div>
        <div class="modal-body" id="sequenceDetailsContent">
            <!-- Sequence Details Tabs -->
            <div class="sequence-tabs">
                <button class="sequence-tab-btn active" data-tab="overview">Overview</button>
                <button class="sequence-tab-btn" data-tab="entries">Entries</button>
                <button class="sequence-tab-btn" data-tab="beta-test">Beta Test</button>
            </div>

            <!-- Overview Tab -->
            <div class="sequence-tab-content active" id="overview-tab">
                <div class="sequence-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Entries:</span>
                        <span class="stat-value" id="sequenceTotalEntries">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active:</span>
                        <span class="stat-value" id="sequenceActiveEntries">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Completed:</span>
                        <span class="stat-value" id="sequenceCompletedEntries">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Max Attempts:</span>
                        <span class="stat-value" id="sequenceMaxAttempts">3</span>
                    </div>
                </div>
            </div>

            <!-- Entries Tab -->
            <div class="sequence-tab-content" id="entries-tab">
                <div class="sequence-entries">
                    <h4>Sequence Entries</h4>
                    <div class="entries-table" id="sequenceEntriesTable">
                        <div class="loading">Loading entries...</div>
                    </div>
                </div>
            </div>

            <!-- Beta Test Tab -->
            <div class="sequence-tab-content" id="beta-test-tab">
                <div class="beta-test-section">
                    <div class="beta-test-header">
                        <h4>ü§ñ Agent Performance Comparison</h4>
                        <p>Compare metrics across different agents assigned to this sequence</p>
                    </div>

                    <!-- Date Filters -->
                    <div class="date-filters">
                        <div class="form-group">
                            <label for="beta-from-date">From:</label>
                            <input type="date" id="beta-from-date" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="beta-to-date">To:</label>
                            <input type="date" id="beta-to-date" class="form-input">
                        </div>
                        <button type="button" id="refresh-beta-metrics" class="btn btn-secondary">üîÑ Refresh</button>
                    </div>

                    <!-- Metrics Table -->
                    <div class="beta-metrics-table" id="beta-metrics-table">
                        <div class="loading">Loading agent metrics...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add to Sequence Modal -->
<div id="addToSequenceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add to Sequence</h3>
            <span class="close" onclick="closeAddToSequenceModal()">&times;</span>
        </div>
        <div class="modal-body" id="addToSequenceContent">
            <div class="form-group">
                <label for="sequenceSelect">Select Sequence</label>
                <select id="sequenceSelect" required>
                    <option value="">Choose a sequence...</option>
                </select>
            </div>
            <div class="selected-items">
                <h4>Selected Items</h4>
                <div id="selectedItemsList"></div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="addToSequence()">Add to Sequence</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddToSequenceModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
        // API base URL
        const API_BASE = '';
        
        // Submission tracking
        let isSubmitting = false;
        let lastSubmissionTime = 0;
        
        // DOM elements
        const serverStatus = document.getElementById('server-status');
        const elevenlabsStatus = document.getElementById('elevenlabs-status');
        const agentStatus = document.getElementById('agent-status');
        const apiKeyStatus = document.getElementById('api-key-status');
        const agentIdStatus = document.getElementById('agent-id-status');
        const phoneIdStatus = document.getElementById('phone-id-status');
        const batchCallerStatus = document.getElementById('batch-caller-status');
        const batchCallerDetails = document.getElementById('batch-caller-details');
        // Legacy Sequence Caller DOM elements removed
        const callForm = document.getElementById('call-form');
        const callBtn = document.getElementById('call-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const callStatus = document.getElementById('call-status');
        const callMessage = document.getElementById('call-message');
        const activeCalls = document.getElementById('active-calls');
        const aiConversations = document.getElementById('ai-conversations');
        const playStreams = document.getElementById('play-streams');
        
        // Dashboard elements
        const tabLinks = document.querySelectorAll('.tabbar-link');
        const dashboardContents = document.querySelectorAll('.dashboard-content');
        const refreshCallsBtn = document.getElementById('refresh-calls-btn');
        const syncCallsBtn = document.getElementById('sync-calls-btn');
        const refreshAnalyticsBtn = document.getElementById('refresh-analytics-btn');
        const callsTableContent = document.getElementById('calls-table-content');

        
        // Update status indicator
        function updateStatus(element, success, message) {
            element.textContent = message;
            element.className = 'status-value ' + (success ? 'status-connected' : 'status-disconnected');
        }
        
        // Show call status message
        function showCallStatus(type, message) {
            callStatus.className = `call-status ${type}`;
            callMessage.textContent = message;
            callStatus.style.display = 'block';
        }
        
        // Hide call status message
        function hideCallStatus() {
            callStatus.style.display = 'none';
        }
        
        // Tab navigation
        function switchTab(tabName) {
            // Update active tab
            tabLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-tab') === tabName) {
                    link.classList.add('active');
                }
            });
            
            // Show active content
            dashboardContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                }
            });
            
            // Load data for the active tab
            if (tabName === 'calls') {
                loadCalls(1);
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'contacts') {
                loadContacts(1);
            } else if (tabName === 'sequences') {
                loadSequences(1);
            } else if (tabName === 'phone-numbers') {
                loadPhoneNumbers(1);
            }
        }
        
        // Load calls data with advanced filtering and backend pagination
        async function loadCalls(page = 1) {
            try {
                callsTableContent.innerHTML = '<div class="loading">Loading calls...</div>';
                
                // Get filter values
                const filters = getActiveFilters();
                
                // Build query string
                const queryParams = new URLSearchParams();
                if (filters.callResult) queryParams.append('callResult', filters.callResult);
                if (filters.phone) queryParams.append('phone', filters.phone);
                if (filters.dateStart) queryParams.append('dateStart', filters.dateStart);
                if (filters.dateEnd) queryParams.append('dateEnd', filters.dateEnd);
                if (filters.meetingBooked) queryParams.append('meetingBooked', filters.meetingBooked);
                if (filters.personInterested) queryParams.append('personInterested', filters.personInterested);
                if (filters.personUpset) queryParams.append('personUpset', filters.personUpset);
                if (filters.duration) queryParams.append('duration', filters.duration);
                
                // Add pagination parameters
                queryParams.append('page', page);
                queryParams.append('limit', itemsPerPage);
                
                const queryString = queryParams.toString();
                const url = `${API_BASE}/api/calls?${queryString}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allCalls = data.calls || [];
                    totalCalls = data.total || 0;
                    currentPage = data.page || page;
                    const totalPages = data.totalPages || Math.ceil(totalCalls / itemsPerPage);
                    
                    // Apply search filter if search term exists
                    if (searchTerm) {
                        filteredCalls = allCalls.filter(call => {
                            // Build a single tokenized haystack string per row
                            const haystack = [
                                call.phone_number,
                                call.enhanced_status, // same as call_result
                                call.meeting_booked ? 'meeting booked' : '',
                                call.person_interested ? 'interested' : '',
                                call.person_very_upset ? 'upset' : ''
                            ].join(' ').toLowerCase();
                            
                            return haystack.includes(searchTerm.toLowerCase());
                        });
                    } else {
                        filteredCalls = allCalls;
                    }
                    
                if (filteredCalls.length > 0) {
                    displayCalls(filteredCalls);
                    updatePagination(totalPages, totalCalls);
                } else {
                        callsTableContent.innerHTML = '<div class="no-data">No calls found</div>';
                        hidePagination();
                    }
                } else {
                    callsTableContent.innerHTML = '<div class="no-data">No calls found</div>';
                    hidePagination();
                }
            } catch (error) {
                console.error('Error loading calls:', error);
                callsTableContent.innerHTML = '<div class="no-data">Error loading calls</div>';
                hidePagination();
            }
        }
        
        // Get active filter values
        function getActiveFilters() {
            return {
                callResult: document.getElementById('filter-call-result').value,
                phone: document.getElementById('filter-phone').value,
                dateStart: document.getElementById('filter-date-start').value,
                dateEnd: document.getElementById('filter-date-end').value,
                meetingBooked: document.getElementById('filter-meeting').value,
                personInterested: document.getElementById('filter-interested').value,
                personUpset: document.getElementById('filter-upset').value,
                duration: document.getElementById('filter-duration').value
            };
        }
        
        // Clear all filters
        function clearAllFilters() {
            document.getElementById('filter-call-result').value = '';
            document.getElementById('filter-phone').value = '';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-meeting').value = '';
            document.getElementById('filter-interested').value = '';
            document.getElementById('filter-upset').value = '';
            document.getElementById('filter-duration').value = '';
        }
        
        // Display calls in table - render in order received from backend
        function displayCalls(calls) {
            const tableHTML = `
                <div class="call-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; font-weight: 600; background: #f8f9fa;">
                    <div>Phone Number</div>
                    <div>Date</div>
                    <div>Status</div>
                    <div>Duration</div>
                    <div>Analysis</div>
                    <div>Actions</div>
                </div>
                ${calls.map(call => {
                    // Duration formatting: minutes = Math.floor(duration_seconds/60), seconds = duration_seconds % 60
                    const minutes = call.duration_seconds ? Math.floor(call.duration_seconds / 60) : 0;
                    const seconds = call.duration_seconds ? call.duration_seconds % 60 : 0;
                    const durationText = call.duration_seconds ? `${minutes}m ${seconds}s` : 'N/A';
                    
                    return `
                        <div class="call-row">
                            <div class="call-phone">${call.phone_number && call.phone_number !== 'unknown' ? call.phone_number : 'N/A'}</div>
                            <div class="call-date">${call.start_time ? new Date(call.start_time).toLocaleString() : new Date(call.created_at).toLocaleString()}</div>
                            <div class="call-status-badge status-${call.enhanced_status || 'unknown'}">${call.enhanced_status || 'Unknown'}</div>
                            <div class="call-duration">${durationText}</div>
                            <div class="call-analysis">
                                ${call.meeting_booked ? '‚úÖ' : '‚ùå'} Meeting
                                ${call.person_interested ? '‚úÖ' : '‚ùå'} Interested
                            </div>
                            <div class="call-actions">
                                <button class="btn btn-small btn-secondary" onclick="viewCallDetails('${call.id}')">View</button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
            
            callsTableContent.innerHTML = tableHTML;
        }
        
        // Update call counts and pagination info
        function updateCallCounts(totalFiltered) {
            const callsCount = document.getElementById('calls-count');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (callsCount) {
                callsCount.textContent = `(${totalFiltered} calls)`;
            }
            
            if (paginationInfo) {
                // Check if current page is valid for the filtered results
                const totalPages = Math.ceil(totalFiltered / itemsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = 1; // Reset to first page if current page is beyond available pages
                }
                
                const startIndex = (currentPage - 1) * itemsPerPage + 1;
                const endIndex = Math.min(currentPage * itemsPerPage, totalFiltered);
                
                // Ensure we don't show invalid ranges
                if (totalFiltered === 0) {
                    paginationInfo.textContent = `Showing 0-0 of 0`;
                } else if (startIndex > totalFiltered) {
                    paginationInfo.textContent = `Showing 0-0 of ${totalFiltered}`;
                } else {
                    paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalFiltered}`;
                }
            }
        }
        
        // Update pagination controls with backend data (unified)
        function updatePagination(totalPages, totalCalls) {
            const paginationControls = document.getElementById('pagination-controls');
            const pageNumbers = document.getElementById('page-numbers');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (totalPages <= 1) {
                hidePagination();
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Update previous/next buttons
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Update pagination info
            if (paginationInfo) {
                const startIndex = (currentPage - 1) * itemsPerPage + 1;
                const endIndex = Math.min(currentPage * itemsPerPage, totalCalls);
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalCalls}`;
            }
            
            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                pageNumbersHTML += `<button class="page-number ${isActive ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
        }
        
        // Hide pagination controls
        function hidePagination() {
            const paginationControls = document.getElementById('pagination-controls');
            if (paginationControls) {
                paginationControls.style.display = 'none';
            }
        }
        
        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            loadCalls(page); // Use backend pagination
        }
        
        // Search functionality
        function performSearch() {
            const searchInput = document.getElementById('search-input');
            searchTerm = searchInput.value.trim();
            currentPage = 1; // Reset to first page when searching
            
            if (allCalls.length > 0) {
                // Apply search filter using haystack approach
                if (searchTerm) {
                    filteredCalls = allCalls.filter(call => {
                        // Build a single tokenized haystack string per row
                        const haystack = [
                            call.phone_number,
                            call.enhanced_status, // same as call_result
                            call.meeting_booked ? 'meeting booked' : '',
                            call.person_interested ? 'interested' : '',
                            call.person_very_upset ? 'upset' : ''
                        ].join(' ').toLowerCase();
                        
                        return haystack.includes(searchTerm.toLowerCase());
                    });
                } else {
                    filteredCalls = allCalls;
                }
                
                if (filteredCalls.length > 0) {
                    displayCalls(filteredCalls);
                    const totalPages = Math.ceil(filteredCalls.length / itemsPerPage);
                    const totalCount = filteredCalls.length;
                    updatePagination(totalPages, totalCount);
                } else {
                    callsTableContent.innerHTML = '<div class="no-data">No calls found matching your search</div>';
                    hidePagination();
                }
            }
        }
        
        // Chart instances
        let charts = {};
        
        // Pagination and search state
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalCalls = 0;
        let allCalls = [];
        let filteredCalls = [];
        let searchTerm = '';
        
        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics`);
                const data = await response.json();
                
                if (data.success) {
                    updateAnalyticsDisplay(data.analytics);
                    createCharts(data.analytics);
                } else {
                    console.error('No analytics data available');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        // Update analytics display
        function updateAnalyticsDisplay(analytics) {
            // Update summary stats
            document.getElementById('total-calls').textContent = analytics.totalCalls || 0;
            document.getElementById('success-rate').textContent = `${analytics.successRate || 0}%`;
            document.getElementById('avg-duration').textContent = `${analytics.avgDuration || 0}m`;
            document.getElementById('meetings-booked').textContent = analytics.meetingsBooked || 0;
        }
        
        // Create charts
        function createCharts(analytics) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Daily Calls Chart
            if (analytics.dailyCalls && analytics.dailyCalls.length > 0) {
                const ctx = document.getElementById('dailyCallsChart');
                if (ctx) {
                    charts.dailyCalls = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: analytics.dailyCalls.map(item => item.date),
                            datasets: [{
                                label: 'Daily Calls',
                                data: analytics.dailyCalls.map(item => item.count),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Success Rate Chart
            if (analytics.dailySuccessRates && analytics.dailySuccessRates.length > 0) {
                const ctx = document.getElementById('successRateChart');
                if (ctx) {
                    charts.successRate = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: analytics.dailySuccessRates.map(item => item.date),
                            datasets: [{
                                label: 'Success Rate %',
                                data: analytics.dailySuccessRates.map(item => item.rate),
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Duration Chart
            if (analytics.dailyDurations && analytics.dailyDurations.length > 0) {
                const ctx = document.getElementById('durationChart');
                if (ctx) {
                    charts.duration = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: analytics.dailyDurations.map(item => item.date),
                            datasets: [{
                                label: 'Avg Duration (minutes)',
                                data: analytics.dailyDurations.map(item => item.avgDuration),
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + 'm';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Hourly Distribution Chart
            if (analytics.hourlyDistribution) {
                const ctx = document.getElementById('hourlyChart');
                if (ctx) {
                    const hours = Array.from({length: 24}, (_, i) => i);
                    const data = hours.map(hour => analytics.hourlyDistribution[hour] || 0);
                    
                    charts.hourly = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: hours.map(h => h + ':00'),
                            datasets: [{
                                label: 'Calls per Hour',
                                data: data,
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Status Breakdown Chart
            if (analytics.statusBreakdown) {
                const ctx = document.getElementById('statusChart');
                if (ctx) {
                    const labels = Object.keys(analytics.statusBreakdown);
                    const data = Object.values(analytics.statusBreakdown);
                    const colors = ['#28a745', '#dc3545', '#ffc107', '#6c757d'];
                    
                    charts.status = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors.slice(0, labels.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }
            
            // Duration Distribution Chart
            if (analytics.durationDistribution) {
                const ctx = document.getElementById('durationDistributionChart');
                if (ctx) {
                    const labels = Object.keys(analytics.durationDistribution);
                    const data = Object.values(analytics.durationDistribution);
                    
                    charts.durationDistribution = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Number of Calls',
                                data: data,
                                backgroundColor: 'rgba(255, 193, 7, 0.6)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Top Phone Numbers Chart
            if (analytics.topPhoneNumbers && analytics.topPhoneNumbers.length > 0) {
                const ctx = document.getElementById('phoneNumbersChart');
                if (ctx) {
                    const labels = analytics.topPhoneNumbers.map(item => item.phone);
                    const data = analytics.topPhoneNumbers.map(item => item.count);
                    
                    charts.phoneNumbers = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Call Count',
                                data: data,
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: '#667eea',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // View call details
        async function viewCallDetails(callId) {
            try {
                // Show modal with loading state
                const modal = document.getElementById('callDetailsModal');
                const content = document.getElementById('callDetailsContent');
                content.innerHTML = '<div class="loading">Loading call details...</div>';
                modal.style.display = 'block';
                
                // Fetch call details
                const response = await fetch(`${API_BASE}/api/calls/${callId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayCallDetails(data.callDetails);
                } else {
                    content.innerHTML = '<div class="no-data">Error loading call details</div>';
                }
            } catch (error) {
                console.error('Error loading call details:', error);
                document.getElementById('callDetailsContent').innerHTML = '<div class="no-data">Error loading call details</div>';
            }
        }
        
        // Display call details in modal
        function displayCallDetails(callDetails) {
            const content = document.getElementById('callDetailsContent');
            const call = callDetails.call;
            const transcriptions = callDetails.transcriptions || [];
            const analysis = callDetails.bookingAnalysis || {};
            
            const html = `
                <div class="call-detail-section">
                    <h4>üìû Call Information</h4>
                    <div class="call-detail-grid">
                        <div class="call-detail-item">
                            <div class="call-detail-label">Phone Number</div>
                            <div class="call-detail-value">${call.phone_number || 'N/A'}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Result</div>
                            <div class="call-detail-value">
                                <span class="call-status-badge status-${call.call_result || 'unknown'}">
                                    ${call.call_result || 'Unknown'}
                                </span>
                            </div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Duration</div>
                            <div class="call-detail-value">${call.duration_seconds ? Math.round(call.duration_seconds / 60) + 'm ' + (call.duration_seconds % 60) + 's' : 'N/A'}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Messages</div>
                            <div class="call-detail-value">${call.message_count || 0}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Start Time</div>
                            <div class="call-detail-value">${call.start_time ? new Date(call.start_time).toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Created</div>
                            <div class="call-detail-value">${new Date(call.created_at).toLocaleString()}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">Answered</div>
                            <div class="call-detail-value">${call.call_result === 'answered' ? '‚úÖ Yes' : '‚ùå No'}</div>
                        </div>
                        <div class="call-detail-item">
                            <div class="call-detail-label">External Call</div>
                            <div class="call-detail-value">${call.is_external_call ? '‚úÖ Yes' : '‚ùå No'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="call-detail-section">
                    <h4>üí¨ Transcript</h4>
                    <div class="transcript-section">
                        ${transcriptions.length > 0 ? 
                            transcriptions.map(transcript => `
                                <div class="transcript-item">
                                    <div class="transcript-speaker">${transcript.speaker || 'Unknown'}</div>
                                    <div class="transcript-text">${transcript.message || transcript.text || 'No text available'}</div>
                                </div>
                            `).join('') 
                            : 
                            `<div class="transcript-item">
                                <div class="transcript-speaker">System</div>
                                <div class="transcript-text">No transcript available for this call. This could be because:
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    <li>The call was very short or had no conversation</li>
                                    <li>The transcript data is not available from ElevenLabs</li>
                                    <li>The call was made outside the app</li>
                                </ul>
                                </div>
                            </div>`
                        }
                    </div>
                </div>
                
                ${analysis && Object.keys(analysis).length > 0 ? `
                <div class="call-detail-section">
                    <h4>üìä Analysis</h4>
                    <div class="analysis-section">
                        <div class="analysis-item">
                            <span class="analysis-label">Meeting Booked</span>
                            <span class="analysis-value">${analysis.meeting_booked ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">Person Interested</span>
                            <span class="analysis-value">${analysis.person_interested ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">Person Very Upset</span>
                            <span class="analysis-value">${analysis.person_very_upset ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            content.innerHTML = html;
        }
        
        // Close call details modal
        function closeCallDetailsModal() {
            document.getElementById('callDetailsModal').style.display = 'none';
        }
        
        // Removed unused setActiveTab()
        
        // Check system status
        async function checkStatus() {
            try {
                // Check server health
                const healthResponse = await fetch(`${API_BASE}/health`);
                const health = await healthResponse.json();
                updateStatus(serverStatus, health.status === 'ok', health.status === 'ok' ? 'Connected' : 'Error');
                
                // Check ElevenLabs connection
                const elevenlabsResponse = await fetch(`${API_BASE}/test-elevenlabs`);
                const elevenlabs = await elevenlabsResponse.json();
                updateStatus(elevenlabsStatus, elevenlabs.success, elevenlabs.success ? 'Connected' : 'Disconnected');
                
                // Check Agent status
                const agentResponse = await fetch(`${API_BASE}/elevenlabs/agents`);
                const agent = await agentResponse.json();
                updateStatus(agentStatus, agent.success, agent.success ? 'Ready' : 'Not Available');
                
                // Check environment variables status
                const envResponse = await fetch(`${API_BASE}/env-status`);
                const env = await envResponse.json();
                updateStatus(apiKeyStatus, env.elevenlabsApiKey, env.elevenlabsApiKey ? 'Set' : 'Missing');
                updateStatus(agentIdStatus, env.elevenlabsAgentId, env.elevenlabsAgentId ? 'Set' : 'Missing');
                updateStatus(phoneIdStatus, env.elevenlabsPhoneNumberId, env.elevenlabsPhoneNumberId ? 'Set' : 'Missing');
                
                // Check batch caller status
                const batchCallerResponse = await fetch(`${API_BASE}/api/sequence-batch-caller/status`);
                const batchCaller = await batchCallerResponse.json();
                if (batchCaller.success) {
                    const status = batchCaller.status;
                    const isEnabled = status.enabled;
                    const isRunning = status.isTicking;
                    // Batch caller is healthy if enabled (regardless of current tick status)
                    // isTicking is only true during brief tick execution
                    const statusText = isEnabled ? 'Active' : 'Disabled';
                    const isHealthy = isEnabled;
                    updateStatus(batchCallerStatus, isHealthy, statusText);
                    
                    // Show additional details
                    if (isEnabled) {
                        const intervalMinutes = Math.round(status.intervalMs / 60000);
                        const detailsText = `Every ${intervalMinutes}min, Max ${status.maxJobsPerTick} jobs`;
                        updateStatus(batchCallerDetails, true, detailsText);
                    } else {
                        updateStatus(batchCallerDetails, false, 'Disabled');
                    }
                } else {
                    updateStatus(batchCallerStatus, false, 'Error');
                    updateStatus(batchCallerDetails, false, 'Error');
                }
                
                // Update call button state - only need ElevenLabs for integration
                callBtn.disabled = !elevenlabs.success;
                
                // Legacy Sequence Caller status check removed

            } catch (error) {
                console.error('Status check failed:', error);
                updateStatus(serverStatus, false, 'Error');
                updateStatus(elevenlabsStatus, false, 'Error');
                updateStatus(agentStatus, false, 'Error');
                updateStatus(apiKeyStatus, false, 'Error');
                updateStatus(agentIdStatus, false, 'Error');
                updateStatus(phoneIdStatus, false, 'Error');
                updateStatus(batchCallerStatus, false, 'Error');
                updateStatus(batchCallerDetails, false, 'Error');
                // Legacy Sequence Caller status elements removed
                callBtn.disabled = true;
            }
        }
        
        // Initialize dashboard
        function initDashboard() {
            // Set up tab navigation
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = link.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Set up button event listeners
            refreshCallsBtn.addEventListener('click', () => loadCalls(1));
            syncCallsBtn.addEventListener('click', syncCalls);
            refreshAnalyticsBtn.addEventListener('click', loadAnalytics);
            
            // Set up filter event listeners
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', () => {
                    currentPage = 1; // Reset to first page when applying filters
                    loadCalls(1);
                });
            }
            
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    clearAllFilters();
                    currentPage = 1; // Reset to first page when clearing filters
                    loadCalls(1);
                });
            }
            
            // Set up search and pagination event listeners
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', performSearch);
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        goToPage(currentPage - 1);
                    }
                });
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredCalls.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        goToPage(currentPage + 1);
                    }
                });
            }
            
            // Initial status check
            checkStatus();
            
            // Set up periodic status checks
            setInterval(checkStatus, 30000); // Check every 30 seconds
        }
        
        // Sync calls from ElevenLabs
        async function syncCalls() {
            try {
                syncCallsBtn.disabled = true;
                syncCallsBtn.textContent = 'üîÑ Syncing...';
                
                const response = await fetch(`${API_BASE}/api/sync-calls`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showCallStatus('success', `Synced ${data.syncedCount} calls from ElevenLabs`);
                    loadCalls(1); // Refresh the calls list
                } else {
                    showCallStatus('error', 'Failed to sync calls');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showCallStatus('error', 'Error syncing calls');
            } finally {
                syncCallsBtn.disabled = false;
                syncCallsBtn.textContent = 'üîÑ Sync from ElevenLabs';
            }
        }
        
        // Form submission handler
        callForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isSubmitting) {
                return;
            }
            
            const phoneNumber = document.getElementById('phone-number').value.trim();
            
            if (!phoneNumber) {
                showCallStatus('error', 'Please enter a phone number');
                return;
            }
            
            // Rate limiting
            const now = Date.now();
            if (now - lastSubmissionTime < 5000) {
                showCallStatus('error', 'Please wait 5 seconds between calls');
                return;
            }
            
            isSubmitting = true;
            lastSubmissionTime = now;
            callBtn.disabled = true;
            callBtn.textContent = 'üéØ Making Call...';
            hideCallStatus();
            
            try {
                const response = await fetch(`${API_BASE}/make-call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        message: 'Hello! This is your AI assistant calling via ElevenLabs.'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showCallStatus('success', `Call initiated successfully! Call ID: ${result.callInfo?.id || 'N/A'}`);
                    document.getElementById('phone-number').value = '';
                } else {
                    showCallStatus('error', result.message || 'Call failed');
                }
                
            } catch (error) {
                console.error('Call error:', error);
                showCallStatus('error', 'Network error. Please try again.');
            } finally {
                isSubmitting = false;
                callBtn.disabled = false;
                callBtn.textContent = 'üéØ Start ElevenLabs Call';
            }
        });
        
        // Refresh button handler
        refreshBtn.addEventListener('click', () => {
            checkStatus();
            hideCallStatus();
        });
        
        // Load contacts data
        async function loadContacts(page = 1) {
            try {
                const contactsTableContent = document.getElementById('contacts-table-content');
                contactsTableContent.innerHTML = '<div class="loading">Loading contacts...</div>';
                
                // Get filter values
                const nameFilter = document.getElementById('contact-name-filter')?.value || '';
                const emailFilter = document.getElementById('contact-email-filter')?.value || '';
                const companyFilter = document.getElementById('contact-company-filter')?.value || '';
                const statusFilter = document.getElementById('contact-status-filter')?.value || '';
                
                // Build query string
                const queryParams = new URLSearchParams();
                if (nameFilter) queryParams.append('name', nameFilter);
                if (emailFilter) queryParams.append('email', emailFilter);
                if (companyFilter) queryParams.append('company', companyFilter);
                if (statusFilter) queryParams.append('doNotCall', statusFilter);
                
                const queryString = queryParams.toString();
                const url = `${API_BASE}/api/contacts?${queryString}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const contacts = data.contacts || [];
                    
                    // Fetch phone numbers for each contact
                    const contactsWithPhones = await Promise.all(contacts.map(async (contact) => {
                        try {
                            const phoneResponse = await fetch(`${API_BASE}/api/phone-numbers?contactId=${contact.id}`);
                            const phoneData = await phoneResponse.json();
                            return {
                                ...contact,
                                phone_numbers: phoneData.success ? phoneData.phoneNumbers : []
                            };
                        } catch (error) {
                            console.error('Error fetching phone numbers for contact:', contact.id, error);
                            return {
                                ...contact,
                                phone_numbers: []
                            };
                        }
                    }));
                    
                    displayContacts(contactsWithPhones);
                } else {
                    contactsTableContent.innerHTML = '<div class="no-data">No contacts found</div>';
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contacts-table-content').innerHTML = '<div class="no-data">Error loading contacts</div>';
            }
        }

        // Display contacts in table
        function displayContacts(contacts) {
            const contactsTableContent = document.getElementById('contacts-table-content');
            
            if (contacts.length === 0) {
                contactsTableContent.innerHTML = '<div class="no-data">No contacts found</div>';
                return;
            }
            
            const contactsHtml = contacts.map(contact => {
                const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Unknown';
                const statusClass = contact.do_not_call ? 'status-do-not-call' : 'status-active';
                const statusText = contact.do_not_call ? 'Do Not Call' : 'Active';
                
                return `
                    <div class="contact-row">
                        <div class="contact-name">${fullName}</div>
                        <div class="contact-email">${contact.email || 'N/A'}</div>
                        <div class="contact-company">${contact.company_name || 'N/A'}</div>
                        <div class="contact-position">${contact.position || 'N/A'}</div>
                        <div class="contact-phones">
                            <div class="phone-number" onclick="viewCallsForPhone('${contact.id}', '${contact.phone_numbers?.[0]?.phone_number || 'N/A'}')" style="cursor: pointer; color: #007bff;">${contact.phone_numbers?.[0]?.phone_number || 'N/A'}</div>
                            <div class="phone-type">${contact.phone_numbers?.[0]?.phone_type || 'N/A'}</div>
                        </div>
                        <div class="contact-status ${statusClass}">${statusText}</div>
                        <div class="contact-actions">
                            <button class="btn btn-small btn-edit" onclick="editContact('${contact.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="deleteContact('${contact.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsTableContent.innerHTML = contactsHtml;
        }

        // Load sequences data
        async function loadSequences(page = 1) {
            try {
                const sequencesTableContent = document.getElementById('sequences-table-content');
                sequencesTableContent.innerHTML = '<div class="loading">Loading sequences...</div>';
                
                // Get filter values
                const nameFilter = document.getElementById('sequence-name-filter')?.value || '';
                const statusFilter = document.getElementById('sequence-status-filter')?.value || '';
                
                // Build query string
                const queryParams = new URLSearchParams();
                if (nameFilter) queryParams.append('name', nameFilter);
                if (statusFilter) queryParams.append('isActive', statusFilter);
                
                const queryString = queryParams.toString();
                const url = `${API_BASE}/api/sequences?${queryString}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const sequences = data.sequences || [];
                    displaySequences(sequences);
                } else {
                    sequencesTableContent.innerHTML = '<div class="no-data">No sequences found</div>';
                }
            } catch (error) {
                console.error('Error loading sequences:', error);
                document.getElementById('sequences-table-content').innerHTML = '<div class="no-data">Error loading sequences</div>';
            }
        }

        // Display sequences in table
        function displaySequences(sequences) {
            const sequencesTableContent = document.getElementById('sequences-table-content');
            
            if (sequences.length === 0) {
                sequencesTableContent.innerHTML = '<div class="no-data">No sequences found</div>';
                return;
            }
            
            const sequencesHtml = sequences.map(sequence => {
                const statusClass = sequence.is_active ? 'status-active' : 'status-inactive';
                const statusText = sequence.is_active ? 'Active' : 'Inactive';
                
                return `
                    <div class="sequence-row">
                        <div class="sequence-name">${sequence.name}</div>
                        <div class="sequence-description">${sequence.description || 'N/A'}</div>
                        <div>${sequence.max_attempts || 3}</div>
                        <div>${sequence.retry_delay_hours || 24}h</div>
                        <div class="sequence-status ${statusClass}">${statusText}</div>
                        <div class="sequence-entries">
                            <span class="sequence-entries-count">0</span>
                            <button class="btn btn-small btn-view" onclick="showSequenceDetailsModal('${sequence.id}')">View</button>
                        </div>
                        <div class="sequence-actions">
                            <button class="btn btn-small btn-view" onclick="showSequenceDetailsModal('${sequence.id}')">üëÅÔ∏è View</button>
                            <button class="btn btn-small btn-edit" onclick="editSequence('${sequence.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-small ${sequence.is_active ? 'btn-secondary' : 'btn-primary'}" onclick="toggleSequenceStatus('${sequence.id}', ${!sequence.is_active})">
                                ${sequence.is_active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Resume'}
                            </button>
                            <button class="btn btn-small btn-delete" onclick="deleteSequence('${sequence.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            sequencesTableContent.innerHTML = sequencesHtml;
            
            // Load sequence statistics for each sequence
            loadSequenceStatistics();
        }

        // Load phone numbers data
        async function loadPhoneNumbers(page = 1) {
            try {
                const phoneNumbersTableContent = document.getElementById('phone-numbers-table-content');
                phoneNumbersTableContent.innerHTML = '<div class="loading">Loading phone numbers...</div>';
                
                // Get filter values
                const phoneNumberFilter = document.getElementById('phone-number-filter')?.value || '';
                const phoneTypeFilter = document.getElementById('phone-type-filter')?.value || '';
                const phoneStatusFilter = document.getElementById('phone-status-filter')?.value || '';
                
                // Build query string
                const queryParams = new URLSearchParams();
                if (phoneNumberFilter) queryParams.append('phoneNumber', phoneNumberFilter);
                if (phoneTypeFilter) queryParams.append('phoneType', phoneTypeFilter);
                if (phoneStatusFilter) queryParams.append('doNotCall', phoneStatusFilter);
                
                const queryString = queryParams.toString();
                const url = `${API_BASE}/api/phone-numbers?${queryString}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const phoneNumbers = data.phoneNumbers || [];
                    displayPhoneNumbers(phoneNumbers);
                } else {
                    phoneNumbersTableContent.innerHTML = '<div class="no-data">No phone numbers found</div>';
                }
            } catch (error) {
                console.error('Error loading phone numbers:', error);
                document.getElementById('phone-numbers-table-content').innerHTML = '<div class="no-data">Error loading phone numbers</div>';
            }
        }

        // Display phone numbers in table
        function displayPhoneNumbers(phoneNumbers) {
            const phoneNumbersTableContent = document.getElementById('phone-numbers-table-content');
            
            if (phoneNumbers.length === 0) {
                phoneNumbersTableContent.innerHTML = '<div class="no-data">No phone numbers found</div>';
                return;
            }
            
            const phoneNumbersHtml = phoneNumbers.map(phone => {
                const isDnc = !!(phone.do_not_call || phone.contacts?.do_not_call);
                const statusClass = isDnc ? 'status-do-not-call' : 'status-active';
                const statusText = isDnc ? 'Do Not Call' : 'Active';
                const contactName = phone.contacts ? `${phone.contacts.first_name || ''} ${phone.contacts.last_name || ''}`.trim() : 'Unknown';
                const companyName = phone.contacts?.company_name || 'N/A';
                
                return `
                    <div class="phone-number-row">
                        <div class="phone-number" onclick="viewCallsForPhoneNumber('${phone.id}', '${phone.phone_number}')" style="cursor: pointer; color: #007bff; font-weight: 600;">${phone.phone_number}</div>
                        <div class="phone-type">${phone.phone_type || 'N/A'}</div>
                        <div class="contact-name">${contactName}</div>
                        <div class="contact-company">${companyName}</div>
                        <div class="contact-status ${statusClass}">${statusText}</div>
                        <div class="sequence-entries">0</div>
                        <div class="contact-actions">
                            <button class="btn btn-small btn-primary" onclick="openAddToSequenceForPhone('${phone.id}', '${phone.phone_number}')">‚ûï To Seq</button>
                            <button class="btn btn-small btn-edit" onclick="editPhoneNumber('${phone.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-delete" onclick="deletePhoneNumber('${phone.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            phoneNumbersTableContent.innerHTML = phoneNumbersHtml;
        }

        // View calls for a specific phone number (from phone numbers tab)
        async function viewCallsForPhoneNumber(phoneId, phoneNumber) {
            try {
                console.log(`Viewing calls for phone number: ${phoneNumber} (ID: ${phoneId})`);
                
                // Get calls for this phone number
                const callsResponse = await fetch(`${API_BASE}/api/phone-numbers/${phoneId}/calls`);
                const callsData = await callsResponse.json();
                
                if (callsData.success) {
                    // Pass the phoneId directly to showCallsModal for sequence lookup
                    await showCallsModal(phoneNumber, callsData.calls, null, phoneId);
                } else {
                    alert('Error loading calls for this phone number');
                }
            } catch (error) {
                console.error('Error viewing calls for phone number:', error);
                alert('Error loading calls for this phone number');
            }
        }

        // View calls for a specific phone number
        async function viewCallsForPhone(contactId, phoneNumber) {
            try {
                console.log(`Viewing calls for phone: ${phoneNumber} (Contact: ${contactId})`);
                
                // First, get the phone number ID
                const phoneResponse = await fetch(`${API_BASE}/api/phone-numbers?contactId=${contactId}&phoneNumber=${phoneNumber}`);
                const phoneData = await phoneResponse.json();
                
                if (!phoneData.success || phoneData.phoneNumbers.length === 0) {
                    alert('Phone number not found');
                    return;
                }
                
                const phoneNumberId = phoneData.phoneNumbers[0].id;
                
                // Get calls for this phone number
                const callsResponse = await fetch(`${API_BASE}/api/phone-numbers/${phoneNumberId}/calls`);
                const callsData = await callsResponse.json();
                
                if (callsData.success) {
                    showCallsModal(phoneNumber, callsData.calls, contactId);
                } else {
                    alert('Error loading calls for this phone number');
                }
            } catch (error) {
                console.error('Error viewing calls for phone:', error);
                alert('Error loading calls for this phone number');
            }
        }

        // Show calls modal for a specific phone number (optionally with phoneNumberId)
        async function showCallsModal(phoneNumber, calls, contactId = null, phoneNumberId = null) {
            const modal = document.getElementById('callDetailsModal');
            const content = document.getElementById('callDetailsContent');
            
            // Resolve phone number ID to fetch sequence information
            if (!phoneNumberId && contactId) {
                try {
                    const phoneResponse = await fetch(`${API_BASE}/api/phone-numbers?contactId=${contactId}&phoneNumber=${phoneNumber}`);
                    const phoneData = await phoneResponse.json();
                    if (phoneData.success && phoneData.phoneNumbers.length > 0) {
                        phoneNumberId = phoneData.phoneNumbers[0].id;
                    }
                } catch (error) {
                    console.error('Error getting phone number ID:', error);
                }
            }
            
            // Get sequence information if we have a phone number ID
            let sequenceInfo = '';
            if (phoneNumberId) {
                try {
                    const sequenceResponse = await fetch(`${API_BASE}/api/phone-numbers/${phoneNumberId}/sequences`);
                    const sequenceData = await sequenceResponse.json();
                    
                    if (sequenceData.success && sequenceData.entries.length > 0) {
                        const entries = sequenceData.entries;
                        sequenceInfo = `
                            <div class="sequence-info-section">
                                <h5>üîÑ Sequence Information</h5>
                                <div class="sequence-entries-list">
                                    ${entries.map(entry => {
                                        const sequenceName = entry.sequences?.name || 'Unknown Sequence';
                                        const statusBadge = `<span class="status-badge ${entry.status}">${entry.status}</span>`;
                                        const attempts = `${entry.current_attempt}/${entry.sequences?.max_attempts || 3}`;
                                        const nextCall = entry.next_call_time ? new Date(entry.next_call_time).toLocaleString() : 'N/A';
                                        
                                        return `
                                            <div class="sequence-entry-item">
                                                <div class="sequence-name">${sequenceName}</div>
                                                <div class="sequence-status">${statusBadge}</div>
                                                <div class="sequence-attempts">Attempts: ${attempts}</div>
                                                <div class="sequence-next-call">Next Call: ${nextCall}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        sequenceInfo = `
                            <div class="sequence-info-section">
                                <h5>üîÑ Sequence Information</h5>
                                <div class="no-sequence-info">Not in any active sequences</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading sequence information:', error);
                    sequenceInfo = `
                        <div class="sequence-info-section">
                            <h5>üîÑ Sequence Information</h5>
                            <div class="no-sequence-info">Error loading sequence information</div>
                        </div>
                    `;
                }
            }
            
            const callsHtml = calls.length > 0 ? calls.map(call => {
                const statusClass = getStatusClass(call.call_result);
                const statusText = getStatusText(call.call_result);
                const date = new Date(call.created_at).toLocaleString();
                const duration = call.duration_seconds ? 
                    `${Math.floor(call.duration_seconds / 60)}m ${call.duration_seconds % 60}s` : 'N/A';
                
                return `
                    <div class="call-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;">
                        <div class="call-phone">${phoneNumber}</div>
                        <div class="call-date">${date}</div>
                        <div class="call-status-badge ${statusClass}">${statusText}</div>
                        <div class="call-duration">${duration}</div>
                        <div class="call-actions">
                            <button class="btn btn-small btn-view" onclick="viewCallDetails('${call.id}')">View</button>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="no-data">No calls found for this phone number</div>';
            
            content.innerHTML = `
                <div class="call-detail-section">
                    <h4>üìû Calls for ${phoneNumber}</h4>
                    ${sequenceInfo}
                    <div class="calls-table">
                        <div class="calls-table-header">
                            <div class="calls-header-left">
                                <span>Call History</span>
                                <span class="calls-count">(${calls.length} calls)</span>
                            </div>
                        </div>
                        <div class="calls-table-content">
                            ${callsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Helper functions for status
        function getStatusClass(result) {
            switch(result) {
                case 'answered': return 'status-answered';
                case 'failed': return 'status-failed';
                case 'unanswered': return 'status-unanswered';
                default: return 'status-in-progress';
            }
        }

        function getStatusText(result) {
            switch(result) {
                case 'answered': return 'Answered';
                case 'failed': return 'Failed';
                case 'unanswered': return 'Unanswered';
                default: return 'In Progress';
            }
        }

        // Contact and Phone Number Management Functions
        async function editContact(contactId) {
            try {
                console.log('Edit contact:', contactId);
                
                // Fetch contact details
                const response = await fetch(`${API_BASE}/api/contacts/${contactId}`);
                const data = await response.json();
                
                if (data.success) {
                    showContactModal(data.contact, 'edit');
                } else {
                    alert('Error loading contact details');
                }
            } catch (error) {
                console.error('Error loading contact:', error);
                alert('Error loading contact details');
            }
        }

        async function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact? This will also delete all associated phone numbers.')) {
                try {
                    console.log('Delete contact:', contactId);
                    
                    const response = await fetch(`${API_BASE}/api/contacts/${contactId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Contact deleted successfully');
                        loadContacts(1);
                    } else {
                        alert('Error deleting contact');
                    }
                } catch (error) {
                    console.error('Error deleting contact:', error);
                    alert('Error deleting contact');
                }
            }
        }

        async function editPhoneNumber(phoneId) {
            try {
                console.log('Edit phone number:', phoneId);
                
                // Fetch phone number details
                const response = await fetch(`${API_BASE}/api/phone-numbers/${phoneId}`);
                const data = await response.json();
                
                if (data.success) {
                    showPhoneNumberModal(data.phoneNumber, 'edit');
                } else {
                    alert('Error loading phone number details');
                }
            } catch (error) {
                console.error('Error loading phone number:', error);
                alert('Error loading phone number details');
            }
        }

        async function deletePhoneNumber(phoneId) {
            if (confirm('Are you sure you want to delete this phone number?')) {
                try {
                    console.log('Delete phone number:', phoneId);
                    
                    const response = await fetch(`${API_BASE}/api/phone-numbers/${phoneId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Phone number deleted successfully');
                        loadPhoneNumbers(1);
                    } else {
                        alert('Error deleting phone number');
                    }
                } catch (error) {
                    console.error('Error deleting phone number:', error);
                    alert('Error deleting phone number');
                }
            }
        }

        

        // Load sequence statistics
        async function loadSequenceStatistics() {
            try {
                const response = await fetch(`${API_BASE}/api/sequences/statistics`);
                const data = await response.json();
                
                if (data.success) {
                    updateSequenceEntryCounts(data.statistics);
                }
            } catch (error) {
                console.error('Error loading sequence statistics:', error);
            }
        }

        // Update sequence entry counts
        function updateSequenceEntryCounts(stats) {
            const entryCounts = document.querySelectorAll('.sequence-entries-count');
            entryCounts.forEach((countElement) => {
                // Find the sequence name from the parent element
                const sequenceRow = countElement.closest('.sequence-row');
                const sequenceNameElement = sequenceRow.querySelector('.sequence-name');
                const sequenceName = sequenceNameElement ? sequenceNameElement.textContent.trim() : '';

                // Get the count for this specific sequence from stats.sequences
                let count = 0;
                if (stats.sequences && stats.sequences[sequenceName]) {
                    count = stats.sequences[sequenceName].total || 0;
                }

                countElement.textContent = count;
            });
        }

        // Toggle sequence status (pause/resume)
        async function toggleSequenceStatus(sequenceId, isActive) {
            try {
                const response = await fetch(`${API_BASE}/api/sequences/${sequenceId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(isActive ? 'Sequence activated' : 'Sequence paused');
                    loadSequences(1);
                } else {
                    alert('Error updating sequence status');
                }
            } catch (error) {
                console.error('Error toggling sequence status:', error);
                alert('Error updating sequence status');
            }
        }

        // Remove alternative sequence details rendering (use dedicated modal with loadSequenceDetails)

        // (Removed) startBatchCalling - unused

        // (Removed) viewBatchQueue - unused

        // (Removed) showBatchQueueModal - unused

        // Show contact modal for adding/editing
        function showContactModal(contact = null, mode = 'add') {
            const modal = document.getElementById('callDetailsModal');
            const content = document.getElementById('callDetailsContent');
            
            const isEdit = mode === 'edit';
            const title = isEdit ? 'Edit Contact' : 'Add New Contact';
            
            content.innerHTML = `
                <div class="call-detail-section">
                    <h4>${title}</h4>
                    <form id="contact-form" onsubmit="saveContact(event, '${mode}', '${contact?.id || ''}')">
                        <div class="form-group">
                            <label for="contact-first-name">First Name</label>
                            <input type="text" id="contact-first-name" name="first_name" value="${contact?.first_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-last-name">Last Name</label>
                            <input type="text" id="contact-last-name" name="last_name" value="${contact?.last_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-email">Email</label>
                            <input type="email" id="contact-email" name="email" value="${contact?.email || ''}">
                        </div>
                        <div class="form-group">
                            <label for="contact-company">Company</label>
                            <input type="text" id="contact-company" name="company_name" value="${contact?.company_name || ''}">
                        </div>
                        <div class="form-group">
                            <label for="contact-position">Position</label>
                            <input type="text" id="contact-position" name="position" value="${contact?.position || ''}">
                        </div>
                        <div class="form-group">
                            <label for="contact-notes">Notes</label>
                            <textarea id="contact-notes" name="notes" rows="3">${contact?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="contact-do-not-call" name="do_not_call" ${contact?.do_not_call ? 'checked' : ''}>
                                Do Not Call
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">${isEdit ? 'Update Contact' : 'Add Contact'}</button>
                            <button type="button" class="btn btn-secondary" onclick="closeCallDetailsModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Show phone number modal for adding/editing
        function showPhoneNumberModal(phoneNumber = null, mode = 'add') {
            const modal = document.getElementById('callDetailsModal');
            const content = document.getElementById('callDetailsContent');
            
            const isEdit = mode === 'edit';
            const title = isEdit ? 'Edit Phone Number' : 'Add New Phone Number';
            
            content.innerHTML = `
                <div class="call-detail-section">
                    <h4>${title}</h4>
                    <form id="phone-number-form" onsubmit="savePhoneNumber(event, '${mode}', '${phoneNumber?.id || ''}')">
                        <div class="form-group">
                            <label for="phone-number-input">Phone Number</label>
                            <input type="tel" id="phone-number-input" name="phone_number" value="${phoneNumber?.phone_number || ''}" required pattern="^\+?[1-9]\d{1,14}$" placeholder="+1234567890 or 1234567890">
                            <small style="color: #666; font-size: 0.9em;">Enter in international format (e.g., +1234567890 or 1234567890)</small>
                        </div>
                        <div class="form-group">
                            <label for="phone-type">Type</label>
                            <select id="phone-type" name="phone_type" required>
                                <option value="mobile" ${phoneNumber?.phone_type === 'mobile' ? 'selected' : ''}>Mobile</option>
                                <option value="home" ${phoneNumber?.phone_type === 'home' ? 'selected' : ''}>Home</option>
                                <option value="work" ${phoneNumber?.phone_type === 'work' ? 'selected' : ''}>Work</option>
                                <option value="other" ${phoneNumber?.phone_type === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phone-contact">Contact (Optional)</label>
                            <select id="phone-contact" name="contact_id">
                                <option value="">No Contact</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="phone-is-primary" name="is_primary" ${phoneNumber?.is_primary ? 'checked' : ''}>
                                Primary Phone Number
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="phone-do-not-call" name="do_not_call" ${phoneNumber?.do_not_call ? 'checked' : ''}>
                                Do Not Call
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">${isEdit ? 'Update Phone Number' : 'Add Phone Number'}</button>
                            <button type="button" class="btn btn-secondary" onclick="closeCallDetailsModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            // Load contacts for the dropdown
            loadContactsForDropdown();
            
            modal.style.display = 'block';
        }

        // Load contacts for dropdown
        async function loadContactsForDropdown() {
            try {
                const response = await fetch(`${API_BASE}/api/contacts`);
                const data = await response.json();
                
                if (data.success) {
                    const contactSelect = document.getElementById('phone-contact');
                    if (contactSelect) {
                        contactSelect.innerHTML = '<option value="">No Contact</option>';
                        data.contacts.forEach(contact => {
                            const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Unknown';
                            contactSelect.innerHTML += `<option value="${contact.id}">${fullName}${contact.company_name ? ` (${contact.company_name})` : ''}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading contacts for dropdown:', error);
            }
        }

        // Save contact
        async function saveContact(event, mode, contactId = '') {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const contactData = {
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                email: formData.get('email'),
                company_name: formData.get('company_name'),
                position: formData.get('position'),
                notes: formData.get('notes'),
                do_not_call: formData.get('do_not_call') === 'on'
            };
            
            try {
                const url = mode === 'edit' ? 
                    `${API_BASE}/api/contacts/${contactId}` : 
                    `${API_BASE}/api/contacts`;
                
                const method = mode === 'edit' ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contactData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(mode === 'edit' ? 'Contact updated successfully' : 'Contact added successfully');
                    closeCallDetailsModal();
                    loadContacts(1);
                } else {
                    alert('Error saving contact');
                }
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('Error saving contact');
            }
        }

        // Save phone number
        async function savePhoneNumber(event, mode, phoneId = '') {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const phoneData = {
                phone_number: formData.get('phone_number'),
                phone_type: formData.get('phone_type'),
                contact_id: formData.get('contact_id') || null,
                is_primary: formData.get('is_primary') === 'on',
                do_not_call: formData.get('do_not_call') === 'on'
            };
            
            try {
                const url = mode === 'edit' ? 
                    `${API_BASE}/api/phone-numbers/${phoneId}` : 
                    `${API_BASE}/api/phone-numbers`;
                
                const method = mode === 'edit' ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(phoneData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(mode === 'edit' ? 'Phone number updated successfully' : 'Phone number added successfully');
                    closeCallDetailsModal();
                    loadPhoneNumbers(1);
                } else {
                    alert('Error saving phone number');
                }
            } catch (error) {
                console.error('Error saving phone number:', error);
                alert('Error saving phone number');
            }
        }

        // ===== CSV UPLOAD FUNCTIONS =====

        // Show upload modal
        function showUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.style.display = 'block';
            
            // Load sequences for dropdown
            loadSequencesForUpload();
        }

        // Close upload modal
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.style.display = 'none';
            
            // Reset form
            document.getElementById('upload-form').reset();
            document.getElementById('file-info').textContent = '';
            document.getElementById('sequence-select').style.display = 'none';
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileInfo = document.getElementById('file-info');
            
            if (file) {
                const fileType = file.name.endsWith('.xlsx') ? 'Excel' : 'CSV';
                fileInfo.textContent = `Selected: ${file.name} (${fileType}, ${(file.size / 1024).toFixed(1)} KB)`;
            } else {
                fileInfo.textContent = '';
            }
        }

        // Handle sequence checkbox change
        function handleSequenceCheckboxChange(event) {
            const sequenceSelect = document.getElementById('sequence-select');
            const sequenceInfo = document.getElementById('sequence-info');

            if (event.target.checked) {
                sequenceSelect.style.display = 'block';
                sequenceInfo.style.display = 'block';
            } else {
                sequenceSelect.style.display = 'none';
                sequenceInfo.style.display = 'none';
            }
        }



        // Load sequences for upload dropdown
        async function loadSequencesForUpload() {
            try {
                const response = await fetch(`${API_BASE}/api/sequences`);
                const data = await response.json();

                if (data.success) {
                    const sequenceSelect = document.getElementById('sequence-select');
                    sequenceSelect.innerHTML = '<option value="">Select a sequence...</option>';
                    data.sequences.forEach(sequence => {
                        const option = document.createElement('option');
                        option.value = sequence.id;
                        option.textContent = sequence.name;
                        option.dataset.agentConfig = JSON.stringify(sequence.agent_assignment_config || null);
                        sequenceSelect.appendChild(option);
                    });

                    // Add change listener to show sequence info
                    sequenceSelect.addEventListener('change', showSequenceInfo);
                }
            } catch (error) {
                console.error('Error loading sequences for upload:', error);
            }
        }

        // Show information about the selected sequence
        function showSequenceInfo() {
            const sequenceSelect = document.getElementById('sequence-select');
            const sequenceInfo = document.getElementById('sequence-agent-status');
            const selectedOption = sequenceSelect.options[sequenceSelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                sequenceInfo.textContent = 'Please select a sequence';
                return;
            }

            const agentConfig = JSON.parse(selectedOption.dataset.agentConfig || 'null');

            if (!agentConfig) {
                sequenceInfo.innerHTML = '<span style="color: #6c757d;">No agent configuration - will use default agent</span>';
            } else if (agentConfig.mode === 'single') {
                sequenceInfo.innerHTML = `<span style="color: #28a745;">‚úì Single Agent: ${agentConfig.single.agentId}</span>`;
            } else if (agentConfig.mode === 'distribute') {
                sequenceInfo.innerHTML = `<span style="color: #007bff;">‚úì Multi-Agent: ${agentConfig.distribute.length} agents configured</span>`;
            } else {
                sequenceInfo.innerHTML = '<span style="color: #6c757d;">Unknown agent configuration</span>';
            }
        }

        // Handle CSV upload
        async function handleCSVUpload(event) {
            event.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('csv-file');
            const addToSequence = document.getElementById('add-to-sequence-checkbox').checked;
            const sequenceId = document.getElementById('sequence-select').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a CSV file');
                return;
            }
            
            formData.append('csvFile', fileInput.files[0]);
            
            try {
                const uploadButton = event.target.querySelector('button[type="submit"]');
                uploadButton.disabled = true;
                uploadButton.textContent = 'üì§ Uploading...';
                
                let url = `${API_BASE}/api/contacts/upload`;
                if (addToSequence && sequenceId) {
                    url = `${API_BASE}/api/contacts/upload-to-sequence`;
                    formData.append('sequenceId', sequenceId);
                    // Agent assignment will be handled automatically by the sequence configuration
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showUploadResult(result.result, true);
                    loadContacts(1); // Refresh contacts list
                } else {
                    showUploadResult({ errors: [result.message] }, false);
                }
                
            } catch (error) {
                console.error('Error uploading CSV:', error);
                showUploadResult({ errors: ['Upload failed: ' + error.message] }, false);
            } finally {
                const uploadButton = event.target.querySelector('button[type="submit"]');
                uploadButton.disabled = false;
                uploadButton.textContent = 'üìÅ Upload CSV';
            }
        }

        // Show upload result
        function showUploadResult(result, isSuccess) {
            const uploadContent = document.getElementById('uploadContent');
            
            let resultHtml = `
                <div class="upload-result ${isSuccess ? 'success' : 'error'}">
                    <h4>${isSuccess ? '‚úÖ Upload Successful' : '‚ùå Upload Failed'}</h4>
            `;
            
            if (isSuccess) {
                resultHtml += `
                    <p><strong>Results:</strong></p>
                    <ul>
                        <li>Total rows processed: ${result.total_rows}</li>
                        <li>Contacts created: ${result.contacts_created}</li>
                        <li>Phone numbers created: ${result.phone_numbers_created}</li>
                        <li>Duplicates skipped: ${result.duplicates}</li>
                        ${result.sequence_additions ? `<li>Added to sequence: ${result.sequence_additions}</li>` : ''}
                    </ul>
                `;
            }
            
            if (result.errors && result.errors.length > 0) {
                resultHtml += `
                    <p><strong>Errors:</strong></p>
                    <ul>
                        ${result.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                `;
            }
            
            resultHtml += '</div>';
            
            // Add result to modal
            const existingResult = uploadContent.querySelector('.upload-result');
            if (existingResult) {
                existingResult.remove();
            }
            uploadContent.insertAdjacentHTML('beforeend', resultHtml);
        }

        // Download sample CSV
        function downloadSampleCSV() {
            const csvContent = `first_name,last_name,email,company_name,position,phone_number,phone_type,is_primary,do_not_call,notes
John,Doe,john.doe@example.com,Acme Corp,Manager,+1234567890,mobile,true,false,Test contact
Jane,Smith,jane.smith@example.com,Tech Solutions,Developer,1987654321,mobile,true,false,Lead from conference
Bob,Johnson,bob@bigcompany.com,Big Company,CEO,+1555123456,work,true,false,High priority contact`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample-contacts.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ===== SEQUENCE MODAL FUNCTIONS =====

        // Time normalization helpers
        function toHHMM(time) {
            if (!time) return '';
            // Already HH:MM:SS -> trim seconds for <input type="time">
            if (/^\d{2}:\d{2}:\d{2}$/.test(time)) return time.slice(0, 5);
            // HH:MM or H:MM -> pad hour
            if (/^\d{1,2}:\d{2}$/.test(time)) {
                const [h, m] = time.split(':');
                return `${h.padStart(2, '0')}:${m}`;
            }
            return time;
        }

        function toHHMMSS(time) {
            if (!time) return '';
            // Already HH:MM:SS
            if (/^\d{2}:\d{2}:\d{2}$/.test(time)) return time;
            // HH:MM or H:MM -> append seconds
            if (/^\d{1,2}:\d{2}$/.test(time)) {
                const [h, m] = time.split(':');
                return `${h.padStart(2, '0')}:${m}:00`;
            }
            return time;
        }

        // Handle sequence tab switching
        function switchSequenceTab(tabName) {
            // Update tab buttons
            const tabBtns = document.querySelectorAll('.sequence-tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update tab content
            const tabContents = document.querySelectorAll('.sequence-tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                }
            });

            // Load data for specific tabs
            if (tabName === 'beta-test') {
                loadBetaTestMetrics();
            }
        }

        // Load beta test metrics for current sequence
        async function loadBetaTestMetrics() {
            const sequenceId = document.getElementById('sequenceDetailsModal').dataset.sequenceId;
            if (!sequenceId) return;

            const metricsTable = document.getElementById('beta-metrics-table');
            metricsTable.innerHTML = '<div class="loading">Loading agent metrics...</div>';

            try {
                const fromDate = document.getElementById('beta-from-date').value;
                const toDate = document.getElementById('beta-to-date').value;

                let url = `${API_BASE}/api/sequences/${sequenceId}/agent-metrics`;
                const params = new URLSearchParams();
                if (fromDate) params.append('from', fromDate);
                if (toDate) params.append('to', toDate);
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayBetaTestMetrics(data.metrics);
                } else {
                    metricsTable.innerHTML = '<div class="no-data">Error loading metrics</div>';
                }
            } catch (error) {
                console.error('Error loading beta test metrics:', error);
                metricsTable.innerHTML = '<div class="no-data">Error loading metrics</div>';
            }
        }

        // Display beta test metrics
        function displayBetaTestMetrics(metrics) {
            const metricsTable = document.getElementById('beta-metrics-table');

            if (!metrics || metrics.length === 0) {
                metricsTable.innerHTML = '<div class="no-data">No agent metrics available</div>';
                return;
            }

            let html = `
                <div class="beta-metrics-header">
                    <div>Agent</div>
                    <div>Calls</div>
                    <div>Avg Duration</div>
                    <div>Interest %</div>
                    <div>Meetings %</div>
                    <div>Answer %</div>
                </div>
            `;

            metrics.forEach(metric => {
                html += `
                    <div class="beta-metrics-row">
                        <div class="agent-name">${metric.agentName || 'Unknown Agent'}</div>
                        <div class="metric-value">${metric.n}</div>
                        <div class="metric-value">${metric.avgDuration}s</div>
                        <div class="metric-value ${getMetricClass(metric.interestRate)}">${metric.interestRate}%</div>
                        <div class="metric-value ${getMetricClass(metric.meetingRate)}">${metric.meetingRate}%</div>
                        <div class="metric-value ${getMetricClass(metric.answerRate)}">${metric.answerRate}%</div>
                    </div>
                `;
            });

            metricsTable.innerHTML = html;
        }

        // Get CSS class for metric based on value
        function getMetricClass(value) {
            if (value >= 70) return 'positive';
            if (value >= 30) return 'neutral';
            return 'negative';
        }

        // ===== SETTINGS TAB FUNCTIONS =====

        // Load settings when settings tab is activated
        function loadSettings() {
            console.log('‚öôÔ∏è Loading settings');
            loadPhonePool();
            loadDefaultSettings();
        }

        // Load phone pool configuration
        async function loadPhonePool() {
            try {
                const response = await fetch(`${API_BASE}/api/settings/phone-pool`);
                const data = await response.json();

                if (data.success) {
                    displayPhonePool(data.phones);
                } else {
                    document.getElementById('current-phone-pool').innerHTML = '<div class="no-data">Error loading phone pool</div>';
                }
            } catch (error) {
                console.error('Error loading phone pool:', error);
                document.getElementById('current-phone-pool').innerHTML = '<div class="no-data">Error loading phone pool</div>';
            }
        }

        // Display phone pool in the UI
        function displayPhonePool(phones) {
            const poolContainer = document.getElementById('current-phone-pool');

            if (!phones || phones.length === 0) {
                poolContainer.innerHTML = '<div class="no-data">No phone numbers configured</div>';
                return;
            }

            const phoneItems = phones.map(phone => `
                <div class="phone-pool-item">
                    <span class="phone-id">${phone}</span>
                    <button type="button" class="remove-phone" onclick="removePhone('${phone}')">Remove</button>
                </div>
            `).join('');

            poolContainer.innerHTML = phoneItems;
        }

        // Add a new phone to the pool
        async function addPhone() {
            const phoneInput = document.getElementById('new-phone-id');
            const phoneId = phoneInput.value.trim();

            if (!phoneId) {
                alert('Please enter a phone ID');
                return;
            }

            // Get current pool
            const currentPhones = await getCurrentPhonePool();
            if (currentPhones.includes(phoneId)) {
                alert('This phone ID is already in the pool');
                return;
            }

            // Add new phone
            const newPhones = [...currentPhones, phoneId];

            try {
                const response = await fetch(`${API_BASE}/api/settings/phone-pool`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phones: newPhones })
                });

                const data = await response.json();

                if (data.success) {
                    displayPhonePool(data.phones);
                    phoneInput.value = '';
                    alert(`Phone ${phoneId} added successfully!`);
                } else {
                    alert('Failed to add phone: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding phone:', error);
                alert('Failed to add phone');
            }
        }

        // Remove a phone from the pool
        async function removePhone(phoneId) {
            if (!confirm(`Remove ${phoneId} from the phone pool?`)) return;

            const currentPhones = await getCurrentPhonePool();
            const newPhones = currentPhones.filter(p => p !== phoneId);

            try {
                const response = await fetch(`${API_BASE}/api/settings/phone-pool`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phones: newPhones })
                });

                const data = await response.json();

                if (data.success) {
                    displayPhonePool(data.phones);
                    alert(`Phone ${phoneId} removed successfully!`);
                } else {
                    alert('Failed to remove phone: ' + data.message);
                }
            } catch (error) {
                console.error('Error removing phone:', error);
                alert('Failed to remove phone');
            }
        }

        // Get current phone pool from server
        async function getCurrentPhonePool() {
            try {
                const response = await fetch(`${API_BASE}/api/settings/phone-pool`);
                const data = await response.json();
                return data.success ? data.phones : [];
            } catch (error) {
                console.error('Error getting current phone pool:', error);
                return [];
            }
        }

        // Load default settings (display only)
        function loadDefaultSettings() {
            const defaultAgentId = (window.DEFAULT_AGENT_ID || '').toString();
            const defaultAgentPhone = (window.DEFAULT_AGENT_PHONE || '').toString();
            const elId = document.getElementById('default-agent-id');
            const elPhone = document.getElementById('default-agent-phone');
            if (elId) elId.value = defaultAgentId;
            if (elPhone) elPhone.value = defaultAgentPhone;
        }

        // Handle agent config enable/disable
        function handleAgentConfigToggle() {
            const enableCheckbox = document.getElementById('enableAgentConfig');
            const configContainer = document.getElementById('agentConfigContainer');
            const isEnabled = !!(enableCheckbox && enableCheckbox.checked);

            configContainer.style.display = isEnabled ? 'block' : 'none';

            // Enable/disable all inputs inside container to avoid validating hidden required fields
            const allInputs = configContainer ? configContainer.querySelectorAll('input, select, textarea') : [];
            allInputs.forEach((el) => {
                el.disabled = !isEnabled;
                if (!isEnabled) {
                    el.required = false;
                }
            });

            updateSequenceAssignmentValidation();
        }

        // Handle sequence agent assignment mode change
        function handleSequenceAssignmentModeChange() {
            const singleMode = document.getElementById('sequenceSingleAgentMode');
            const distributeMode = document.getElementById('sequenceDistributeAgentsMode');
            const checked = document.querySelector('input[name="sequenceAssignmentMode"]:checked');
            const mode = checked ? checked.value : 'single';

            if (mode === 'single') {
                singleMode.style.display = 'block';
                distributeMode.style.display = 'none';
            } else {
                singleMode.style.display = 'none';
                distributeMode.style.display = 'block';
            }

            updateSequenceAssignmentValidation();
        }

        // Ensure correct required/disabled attributes based on current state
        function updateSequenceAssignmentValidation() {
            const enableCheckbox = document.getElementById('enableAgentConfig');
            const isEnabled = !!(enableCheckbox && enableCheckbox.checked);

            const singleContainer = document.getElementById('sequenceSingleAgentMode');
            const distributeContainer = document.getElementById('sequenceDistributeAgentsMode');

            const singleInputs = singleContainer ? singleContainer.querySelectorAll('input, select, textarea') : [];
            const distributeInputs = distributeContainer ? distributeContainer.querySelectorAll('input, select, textarea') : [];

            // If not enabled, disable all and remove required
            if (!isEnabled) {
                [...singleInputs, ...distributeInputs].forEach((el) => {
                    el.disabled = true;
                    el.required = false;
                });
                return;
            }

            // Enabled: start by enabling all, then tailor per mode
            [...singleInputs, ...distributeInputs].forEach((el) => {
                el.disabled = false;
            });

            const checked = document.querySelector('input[name="sequenceAssignmentMode"]:checked');
            const mode = checked ? checked.value : 'single';

            if (mode === 'single') {
                // Single mode: require agent ID input, disable distribute inputs
                const singleAgentId = document.getElementById('sequenceSingleAgentId');
                if (singleAgentId) {
                    singleAgentId.required = true;
                }
                distributeInputs.forEach((el) => {
                    el.required = false;
                    el.disabled = true;
                });
            } else {
                // Distribute mode: remove single required and disable single inputs
                singleInputs.forEach((el) => {
                    el.required = false;
                    el.disabled = true;
                });
                // Require each distribute agentId; phones and weights optional
                const distributeAgentIdInputs = document.querySelectorAll('.sequence-agent-item .sequence-agent-id');
                distributeAgentIdInputs.forEach((el) => {
                    el.required = true;
                    el.disabled = false;
                });
                const otherDistributeInputs = document.querySelectorAll('.sequence-agent-item .sequence-agent-phone, .sequence-agent-item .sequence-agent-weight');
                otherDistributeInputs.forEach((el) => {
                    el.required = false;
                    el.disabled = false;
                });
            }
        }

        // Add new sequence agent to the list
        function addSequenceAgent() {
            const agentList = document.getElementById('sequenceAgentList');
            const agentItems = agentList.querySelectorAll('.sequence-agent-item');
            const agentNumber = agentItems.length + 1;

            const agentItem = document.createElement('div');
            agentItem.className = 'sequence-agent-item';
            agentItem.innerHTML = `
                <div class="form-group">
                    <label>Agent ${agentNumber}</label>
                    <input type="text" class="sequence-agent-id" placeholder="Agent ID" class="form-input">
                    <input type="text" class="sequence-agent-phone" placeholder="Phone ID" class="form-input">
                    <input type="number" class="sequence-agent-weight" placeholder="Weight" value="1" min="1" class="form-input weight-input">
                    <button type="button" class="btn btn-small btn-danger remove-sequence-agent">Remove</button>
                </div>
            `;

            agentList.appendChild(agentItem);

            // Add event listener to the remove button
            const removeBtn = agentItem.querySelector('.remove-sequence-agent');
            removeBtn.addEventListener('click', function() {
                agentItem.remove();
                updateSequenceAgentLabels();
            });

            updateSequenceAgentLabels();
            updateSequenceAssignmentValidation();
        }

        // Update sequence agent labels after adding/removing
        function updateSequenceAgentLabels() {
            const agentItems = document.querySelectorAll('.sequence-agent-item');
            agentItems.forEach((item, index) => {
                const label = item.querySelector('label');
                label.textContent = `Agent ${index + 1}`;
            });
        }

        // Add new sequence agent to the list
        function addSequenceAgent() {
            const agentList = document.getElementById('sequenceAgentList');
            const agentItems = agentList.querySelectorAll('.sequence-agent-item');
            const agentNumber = agentItems.length + 1;

            const agentItem = document.createElement('div');
            agentItem.className = 'sequence-agent-item';
            agentItem.innerHTML = `
                <div class="form-group">
                    <label>Agent ${agentNumber}</label>
                    <input type="text" class="sequence-agent-id" placeholder="Agent ID *" class="form-input" required>
                    <input type="text" class="sequence-agent-phone" placeholder="Phone ID (optional)" class="form-input">
                    <input type="number" class="sequence-agent-weight" placeholder="Weight" value="1" min="1" class="form-input weight-input">
                    <button type="button" class="btn btn-small btn-danger remove-sequence-agent">Remove</button>
                </div>
                <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">Leave phone ID empty to use random phone from global pool</small>
            `;

            agentList.appendChild(agentItem);

            // Add event listener to the remove button
            const removeBtn = agentItem.querySelector('.remove-sequence-agent');
            removeBtn.addEventListener('click', function() {
                agentItem.remove();
                updateSequenceAgentLabels();
            });

            updateSequenceAgentLabels();
            updateSequenceAssignmentValidation();
        }

        // Get sequence agent configuration data for form submission
        function getSequenceAgentConfig() {
            const mode = document.querySelector('input[name="sequenceAssignmentMode"]:checked').value;

            if (mode === 'single') {
                const agentId = document.getElementById('sequenceSingleAgentId').value.trim();
                const agentPhone = document.getElementById('sequenceSingleAgentPhone').value.trim();

                if (!agentId) {
                    return null;
                }

                return {
                    mode: 'single',
                    single: {
                        agentId,
                        agentPhoneNumberId: agentPhone || null
                    }
                };
            } else {
                const agentItems = document.querySelectorAll('.sequence-agent-item');
                const agents = [];

                for (const item of agentItems) {
                    const agentId = item.querySelector('.sequence-agent-id').value.trim();
                    const agentPhone = item.querySelector('.sequence-agent-phone').value.trim();
                    const weight = parseInt(item.querySelector('.sequence-agent-weight').value) || 1;

                    if (agentId) {
                        agents.push({
                            agentId,
                            agentPhoneNumberId: agentPhone || null,
                            weight
                        });
                    }
                }

                if (agents.length === 0) {
                    return null;
                }

                return {
                    mode: 'distribute',
                    distribute: agents
                };
            }
        }

        // Populate agent configuration in form when editing
        function populateAgentConfig(agentConfig) {
            if (!agentConfig) return;

            // Enable the agent config
            document.getElementById('enableAgentConfig').checked = true;
            document.getElementById('agentConfigContainer').style.display = 'block';

            // Set the mode
            const modeRadio = document.querySelector(`input[name="sequenceAssignmentMode"][value="${agentConfig.mode}"]`);
            if (modeRadio) {
                modeRadio.checked = true;
                handleSequenceAssignmentModeChange();
            }

            // Populate the fields
            if (agentConfig.mode === 'single' && agentConfig.single) {
                document.getElementById('sequenceSingleAgentId').value = agentConfig.single.agentId || '';
                document.getElementById('sequenceSingleAgentPhone').value = agentConfig.single.agentPhoneNumberId || '';
            } else if (agentConfig.mode === 'distribute' && agentConfig.distribute) {
                // Clear existing agents
                document.getElementById('sequenceAgentList').innerHTML = '';

                // Add each agent
                agentConfig.distribute.forEach((agent, index) => {
                    const agentItem = document.createElement('div');
                    agentItem.className = 'sequence-agent-item';
                    agentItem.innerHTML = `
                        <div class="form-group">
                            <label>Agent ${index + 1}</label>
                            <input type="text" class="sequence-agent-id" placeholder="Agent ID" value="${agent.agentId}" class="form-input">
                            <input type="text" class="sequence-agent-phone" placeholder="Phone ID" value="${agent.agentPhoneNumberId}" class="form-input">
                            <input type="number" class="sequence-agent-weight" placeholder="Weight" value="${agent.weight || 1}" min="1" class="form-input weight-input">
                            <button type="button" class="btn btn-small btn-danger remove-sequence-agent">Remove</button>
                        </div>
                    `;

                    document.getElementById('sequenceAgentList').appendChild(agentItem);

                    // Add event listener to the remove button
                    const removeBtn = agentItem.querySelector('.remove-sequence-agent');
                    removeBtn.addEventListener('click', function() {
                        agentItem.remove();
                        updateSequenceAgentLabels();
                    });
                });
            }
        }

        // Show sequence modal for adding/editing
        function showSequenceModal(sequence = null, mode = 'add') {
            console.log('showSequenceModal called with:', { sequence, mode });

            const modal = document.getElementById('sequenceModal');
            const title = document.getElementById('sequenceModalTitle');
            const form = document.getElementById('sequenceForm');
            
            console.log('Modal elements:', { modal, title, form });
            
            if (!modal || !title || !form) {
                console.error('Required modal elements not found');
                return;
            }
            
            // Reset form
            form.reset();
            
            if (mode === 'edit' && sequence) {
                console.log('Setting up edit mode with sequence:', sequence);
                title.textContent = 'Edit Sequence';
                document.getElementById('sequenceName').value = sequence.name || '';
                document.getElementById('sequenceDescription').value = sequence.description || '';
                document.getElementById('sequenceMaxAttempts').value = sequence.max_attempts || 3;
                document.getElementById('sequenceRetryDelay').value = sequence.retry_delay_hours || 24;
                document.getElementById('sequenceIsActive').checked = sequence.is_active !== false;
                
                // Set business hours fields
                document.getElementById('sequenceTimezone').value = sequence.timezone || 'UTC';
                document.getElementById('sequenceBusinessHoursStart').value = toHHMM(sequence.business_hours_start) || '09:00';
                document.getElementById('sequenceBusinessHoursEnd').value = toHHMM(sequence.business_hours_end) || '17:00';
                document.getElementById('sequenceExcludeWeekends').checked = sequence.exclude_weekends !== false;
                
                // Update business hours preview
                updateBusinessHoursPreview();
                
                // Store sequence ID for update
                form.dataset.sequenceId = sequence.id;
                form.dataset.mode = 'edit';

                // Populate agent configuration if it exists
                if (sequence.agent_assignment_config) {
                    populateAgentConfig(sequence.agent_assignment_config);
                    // Sync validation state with populated config
                    handleAgentConfigToggle();
                    handleSequenceAssignmentModeChange();
                }
            } else {
                console.log('Setting up add mode');
                title.textContent = 'Add Sequence';
                form.dataset.sequenceId = '';
                form.dataset.mode = 'add';

                // Set default business hours
                document.getElementById('sequenceTimezone').value = 'UTC';
                document.getElementById('sequenceBusinessHoursStart').value = '09:00';
                document.getElementById('sequenceBusinessHoursEnd').value = '17:00';
                document.getElementById('sequenceExcludeWeekends').checked = true;

                // Reset agent configuration
                document.getElementById('enableAgentConfig').checked = false;
                document.getElementById('agentConfigContainer').style.display = 'none';
                document.querySelector('input[name="sequenceAssignmentMode"][value="single"]').checked = true;
                document.getElementById('sequenceSingleAgentId').value = '';
                document.getElementById('sequenceSingleAgentPhone').value = '';
                document.getElementById('sequenceAgentList').innerHTML = '';

                // Sync validation state and business hours preview
                updateBusinessHoursPreview();
                handleAgentConfigToggle();
                handleSequenceAssignmentModeChange();
            }
            
            console.log('Showing modal');
            modal.style.display = 'block';
        }

        // Close sequence modal
        function closeSequenceModal() {
            const modal = document.getElementById('sequenceModal');
            modal.style.display = 'none';
        }

        // Show sequence details modal
        function showSequenceDetailsModal(sequenceId) {
            const modal = document.getElementById('sequenceDetailsModal');
            const title = document.getElementById('sequenceDetailsModalTitle');

            title.textContent = 'Sequence Details';

            // Store sequence ID for beta test functionality
            modal.dataset.sequenceId = sequenceId;

            // Load sequence details and entries
            loadSequenceDetails(sequenceId);

            // Set up tab event listeners
            setTimeout(() => {
                const tabBtns = document.querySelectorAll('.sequence-tab-btn');
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => switchSequenceTab(btn.dataset.tab));
                });

                // Set up refresh button for beta test metrics
                const refreshBtn = document.getElementById('refresh-beta-metrics');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => loadBetaTestMetrics());
                }

                // Set default date range (last 7 days)
                const today = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(today.getDate() - 7);

                const fromDateInput = document.getElementById('beta-from-date');
                const toDateInput = document.getElementById('beta-to-date');

                if (fromDateInput && toDateInput) {
                    fromDateInput.value = sevenDaysAgo.toISOString().split('T')[0];
                    toDateInput.value = today.toISOString().split('T')[0];
                }
            }, 100);

            modal.style.display = 'block';
        }

        // Close sequence details modal
        function closeSequenceDetailsModal() {
            const modal = document.getElementById('sequenceDetailsModal');
            modal.style.display = 'none';
        }

        // Load sequence details
        async function loadSequenceDetails(sequenceId) {
            try {
                const [sequenceResponse, entriesResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/sequences/${sequenceId}`),
                    fetch(`${API_BASE}/api/sequences/${sequenceId}/entries`)
                ]);

                const sequenceData = await sequenceResponse.json();
                const entriesData = await entriesResponse.json();

                if (sequenceData.success && entriesData.success) {
                    const sequence = sequenceData.sequence;
                    const entries = entriesData.entries;

                    // Update stats
                    document.getElementById('sequenceTotalEntries').textContent = entries.length;
                    document.getElementById('sequenceActiveEntries').textContent = entries.filter(e => e.status === 'active').length;
                    document.getElementById('sequenceCompletedEntries').textContent = entries.filter(e => e.status === 'completed').length;
                    document.getElementById('sequenceMaxAttempts').textContent = sequence.max_attempts;

                    // Update entries table
                    displaySequenceEntries(entries);
                }
            } catch (error) {
                console.error('Error loading sequence details:', error);
            }
        }

        // Display sequence entries
        function displaySequenceEntries(entries) {
            const table = document.getElementById('sequenceEntriesTable');
            
            if (entries.length === 0) {
                table.innerHTML = '<div class="no-data">No entries found</div>';
                return;
            }

            const entriesHtml = entries.map(entry => {
                const contact = entry.phone_numbers?.contacts;
                const contactName = contact ? `${contact.first_name} ${contact.last_name}`.trim() : 'Unknown';
                const phoneNumber = entry.phone_numbers?.phone_number || 'Unknown';
                
                return `
                    <div class="entry-row">
                        <div class="entry-cell">${contactName}</div>
                        <div class="entry-cell">${phoneNumber}</div>
                        <div class="entry-cell">
                            <span class="status-badge ${entry.status}">${entry.status}</span>
                        </div>
                        <div class="entry-cell">${entry.current_attempt}/${entry.sequences?.max_attempts || 3}</div>
                        <div class="entry-cell">${entry.next_call_time ? new Date(entry.next_call_time).toLocaleString() : 'N/A'}</div>
                    </div>
                `;
            }).join('');

            table.innerHTML = `
                <div class="entries-header">
                    <div class="entry-header-cell">Contact</div>
                    <div class="entry-header-cell">Phone</div>
                    <div class="entry-header-cell">Status</div>
                    <div class="entry-header-cell">Attempts</div>
                    <div class="entry-header-cell">Next Call</div>
                </div>
                ${entriesHtml}
            `;
        }

        // Show add to sequence modal
        function showAddToSequenceModal(selectedItems) {
            const modal = document.getElementById('addToSequenceModal');
            const itemsList = document.getElementById('selectedItemsList');
            
            // Display selected items
            const itemsHtml = selectedItems.map(item => {
                const name = item.name || item.phone_number || 'Unknown';
                return `<div class="selected-item">${name}</div>`;
            }).join('');
            
            itemsList.innerHTML = itemsHtml;
            
            // Load sequences for dropdown
            loadSequencesForDropdown();
            
            modal.style.display = 'block';
        }

        // Close add to sequence modal
        function closeAddToSequenceModal() {
            const modal = document.getElementById('addToSequenceModal');
            modal.style.display = 'none';
        }

        // Load sequences for dropdown
        async function loadSequencesForDropdown() {
            try {
                const response = await fetch(`${API_BASE}/api/sequences?isActive=true`);
                const data = await response.json();
                
                const sequenceSelect = document.getElementById('sequenceSelect');
                sequenceSelect.innerHTML = '<option value="">Choose a sequence...</option>';
                
                if (data.success && data.sequences) {
                    data.sequences.forEach(sequence => {
                        sequenceSelect.innerHTML += `<option value="${sequence.id}">${sequence.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading sequences for dropdown:', error);
            }
        }

        // Add to sequence
        async function addToSequence() {
            const sequenceId = document.getElementById('sequenceSelect').value;
            const selectedItems = window.selectedItems || [];
            
            if (!sequenceId) {
                alert('Please select a sequence');
                return;
            }
            
            if (selectedItems.length === 0) {
                alert('No items selected');
                return;
            }
            
            try {
                const phoneNumberIds = selectedItems.map(item => item.id);
                
                const response = await fetch(`${API_BASE}/api/sequences/${sequenceId}/entries`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumberIds })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully added ${data.result.added} items to sequence`);
                    closeAddToSequenceModal();
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tabbar-link.active').getAttribute('data-tab');
                    if (activeTab === 'contacts') {
                        loadContacts(1);
                    } else if (activeTab === 'phone-numbers') {
                        loadPhoneNumbers(1);
                    }
                } else {
                    alert('Failed to add items to sequence: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding to sequence:', error);
                alert('Failed to add items to sequence');
            }
        }

        // Open add to sequence modal for a specific phone
        function openAddToSequenceForPhone(phoneId, phoneNumber) {
            window.selectedItems = [{ id: phoneId, name: phoneNumber }];
            showAddToSequenceModal(window.selectedItems);
        }

        // Edit sequence
        async function editSequence(sequenceId) {
            try {
                console.log('Edit sequence:', sequenceId);
                
                // Fetch sequence details
                const response = await fetch(`${API_BASE}/api/sequences/${sequenceId}`);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    console.log('Showing sequence modal with data:', data.sequence);
                    showSequenceModal(data.sequence, 'edit');
                } else {
                    console.error('API returned error:', data.message);
                    alert('Error loading sequence details: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading sequence:', error);
                alert('Error loading sequence details: ' + error.message);
            }
        }

        // Delete sequence
        async function deleteSequence(sequenceId) {
            if (!confirm('Are you sure you want to delete this sequence? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/sequences/${sequenceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Sequence deleted successfully');
                    loadSequences(1);
                } else {
                    alert('Failed to delete sequence: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting sequence:', error);
                alert('Failed to delete sequence');
            }
        }

        // Handle sequence form submission
        document.addEventListener('DOMContentLoaded', () => {
            const sequenceForm = document.getElementById('sequenceForm');
            if (sequenceForm) {
                sequenceForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    const formData = new FormData(sequenceForm);
                    const sequenceData = {
                        name: document.getElementById('sequenceName').value,
                        description: document.getElementById('sequenceDescription').value,
                        max_attempts: parseInt(document.getElementById('sequenceMaxAttempts').value),
                        retry_delay_hours: parseInt(document.getElementById('sequenceRetryDelay').value),
                        is_active: document.getElementById('sequenceIsActive').checked,
                        timezone: document.getElementById('sequenceTimezone').value,
                        business_hours_start: toHHMMSS(document.getElementById('sequenceBusinessHoursStart').value),
                        business_hours_end: toHHMMSS(document.getElementById('sequenceBusinessHoursEnd').value),
                        exclude_weekends: document.getElementById('sequenceExcludeWeekends').checked
                    };

                    // Add agent configuration if enabled
                    const enableAgentConfig = document.getElementById('enableAgentConfig').checked;
                    if (enableAgentConfig) {
                        const agentConfig = getSequenceAgentConfig();
                        if (agentConfig) {
                            sequenceData.agentConfig = agentConfig;
                        }
                    }
                    
                    const mode = sequenceForm.dataset.mode;
                    const sequenceId = sequenceForm.dataset.sequenceId;
                    
                    try {
                        let response;
                        if (mode === 'edit') {
                            response = await fetch(`${API_BASE}/api/sequences/${sequenceId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(sequenceData)
                            });
                        } else {
                            response = await fetch(`${API_BASE}/api/sequences`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(sequenceData)
                            });
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert(mode === 'edit' ? 'Sequence updated successfully' : 'Sequence created successfully');
                            closeSequenceModal();
                            loadSequences(1);
                        } else {
                            alert('Failed to save sequence: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error saving sequence:', error);
                        alert('Failed to save sequence');
                    }
                });
                // Initialize validation state on open
                handleAgentConfigToggle();
                handleSequenceAssignmentModeChange();
            }
        });

        // Business Hours Functions
        function updateBusinessHoursPreview() {
            const timezone = document.getElementById('sequenceTimezone').value;
            const startTime = document.getElementById('sequenceBusinessHoursStart').value;
            const endTime = document.getElementById('sequenceBusinessHoursEnd').value;
            const excludeWeekends = document.getElementById('sequenceExcludeWeekends').checked;
            
            const preview = document.getElementById('businessHoursPreview');
            const validation = document.getElementById('businessHoursValidation');
            
            if (preview) {
                const timezoneDisplay = timezone.replace('_', ' ').replace('/', ' / ');
                const weekendText = excludeWeekends ? ' (excluding weekends)' : ' (including weekends)';
                preview.textContent = `Business Hours: ${startTime} - ${endTime} ${timezoneDisplay}${weekendText}`;
            }
            
            // Validate business hours
            validateBusinessHours();
        }
        
        async function validateBusinessHours() {
            const timezone = document.getElementById('sequenceTimezone').value;
            const startTime = document.getElementById('sequenceBusinessHoursStart').value;
            const endTime = document.getElementById('sequenceBusinessHoursEnd').value;
            const excludeWeekends = document.getElementById('sequenceExcludeWeekends').checked;
            
            const validation = document.getElementById('businessHoursValidation');
            
            if (!validation) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/sequences/validate-business-hours`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        timezone,
                        business_hours_start: toHHMMSS(startTime),
                        business_hours_end: toHHMMSS(endTime),
                        exclude_weekends: excludeWeekends
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.isValid) {
                        validation.textContent = '‚úÖ Business hours configuration is valid';
                        validation.className = 'validation-message success';
                    } else {
                        validation.textContent = `‚ùå ${data.errors.join(', ')}`;
                        validation.className = 'validation-message error';
                    }
                } else {
                    validation.textContent = `‚ùå Validation error: ${data.message}`;
                    validation.className = 'validation-message error';
                }
            } catch (error) {
                validation.textContent = '‚ùå Error validating business hours';
                validation.className = 'validation-message error';
            }
        }
        
                    // Add event listeners for agent configuration
            const enableAgentConfig = document.getElementById('enableAgentConfig');
            if (enableAgentConfig) {
                enableAgentConfig.addEventListener('change', handleAgentConfigToggle);
            }

            const sequenceAssignmentModeRadios = document.querySelectorAll('input[name="sequenceAssignmentMode"]');
            sequenceAssignmentModeRadios.forEach(radio => {
                radio.addEventListener('change', handleSequenceAssignmentModeChange);
            });

            const addSequenceAgentBtn = document.getElementById('addSequenceAgentBtn');
            if (addSequenceAgentBtn) {
                addSequenceAgentBtn.addEventListener('click', addSequenceAgent);
            }

            // Add event listeners for dynamically created remove buttons
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-sequence-agent')) {
                    event.target.closest('.sequence-agent-item').remove();
                    updateSequenceAgentLabels();
                    updateSequenceAssignmentValidation();
                }
            });

            // Add event listeners for business hours fields
            document.addEventListener('DOMContentLoaded', function() {
            const timezoneSelect = document.getElementById('sequenceTimezone');
            const startTimeInput = document.getElementById('sequenceBusinessHoursStart');
            const endTimeInput = document.getElementById('sequenceBusinessHoursEnd');
            const excludeWeekendsCheckbox = document.getElementById('sequenceExcludeWeekends');
            
            if (timezoneSelect) {
                timezoneSelect.addEventListener('change', updateBusinessHoursPreview);
            }
            if (startTimeInput) {
                startTimeInput.addEventListener('change', updateBusinessHoursPreview);
            }
            if (endTimeInput) {
                endTimeInput.addEventListener('change', updateBusinessHoursPreview);
            }
            if (excludeWeekendsCheckbox) {
                excludeWeekendsCheckbox.addEventListener('change', updateBusinessHoursPreview);
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            
            // Add event listeners for new buttons
            const addContactBtn = document.getElementById('add-contact-btn');
            if (addContactBtn) {
                addContactBtn.addEventListener('click', () => {
                    showContactModal(null, 'add');
                });
            }
            
            const addPhoneNumberBtn = document.getElementById('add-phone-number-btn');
            if (addPhoneNumberBtn) {
                addPhoneNumberBtn.addEventListener('click', () => {
                    showPhoneNumberModal(null, 'add');
                });
            }
            
            const refreshContactsBtn = document.getElementById('refresh-contacts-btn');
            if (refreshContactsBtn) {
                refreshContactsBtn.addEventListener('click', () => {
                    loadContacts(1);
                });
            }
            
            const refreshPhoneNumbersBtn = document.getElementById('refresh-phone-numbers-btn');
            if (refreshPhoneNumbersBtn) {
                refreshPhoneNumbersBtn.addEventListener('click', () => {
                    loadPhoneNumbers(1);
                });
            }

            // Settings tab event listeners
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    alert('Settings saved successfully!');
                    loadSettings();
                });
            }

            const refreshSettingsBtn = document.getElementById('refresh-settings-btn');
            if (refreshSettingsBtn) {
                refreshSettingsBtn.addEventListener('click', loadSettings);
            }

            const addPhoneBtnSettings = document.getElementById('add-phone-btn');
            if (addPhoneBtnSettings) {
                addPhoneBtnSettings.addEventListener('click', addPhone);
            }

            const newPhoneInput = document.getElementById('new-phone-id');
            if (newPhoneInput) {
                newPhoneInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') addPhone();
                });
            }
            
            // Add sequence button event listener
            const addSequenceBtn = document.getElementById('add-sequence-btn');
            if (addSequenceBtn) {
                addSequenceBtn.addEventListener('click', () => {
                    showSequenceModal(null, 'add');
                });
            }
            
            // Add refresh sequences button event listener
            const refreshSequencesBtn = document.getElementById('refresh-sequences-btn');
            if (refreshSequencesBtn) {
                refreshSequencesBtn.addEventListener('click', () => {
                    loadSequences(1);
                });
            }

            // Upload functionality
            const uploadContactsBtn = document.getElementById('upload-contacts-btn');
            if (uploadContactsBtn) {
                uploadContactsBtn.addEventListener('click', () => {
                    showUploadModal();
                });
            }

            // Upload form handling
            const uploadForm = document.getElementById('upload-form');
            if (uploadForm) {
                uploadForm.addEventListener('submit', handleCSVUpload);
            }

            // File input handling
            const csvFileInput = document.getElementById('csv-file');
            if (csvFileInput) {
                csvFileInput.addEventListener('change', handleFileSelect);
            }

            // Sequence checkbox handling
            const addToSequenceCheckbox = document.getElementById('add-to-sequence-checkbox');
            if (addToSequenceCheckbox) {
                addToSequenceCheckbox.addEventListener('change', handleSequenceCheckboxChange);
            }
        });
    </script>

    <!-- Call Details Modal -->
    <div id="callDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Call Details</h3>
                <span class="close" onclick="closeCallDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="callDetailsContent">
                <div class="loading">Loading call details...</div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÅ Upload Contacts CSV</h3>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <div class="modal-body" id="uploadContent">
                <div class="upload-section">
                    <div class="csv-format-info">
                        <h4>üìã File Format Requirements</h4>
                        <div class="format-grid">
                            <div class="format-item">
                                <strong>Supported formats:</strong>
                                <ul>
                                    <li>CSV files (.csv)</li>
                                    <li>Excel files (.xlsx)</li>
                                </ul>
                            </div>
                            <div class="format-item">
                                <strong>Required columns:</strong>
                                <ul>
                                    <li>first_name (or last_name)</li>
                                    <li>phone_number (international format: +1234567890 or 1234567890; spaces like "+44 7515 88089" are OK)</li>
                                </ul>
                            </div>
                            <div class="format-item">
                                <strong>Optional columns:</strong>
                                <ul>
                                    <li>last_name, email, company_name, position</li>
                                    <li>phone_type (mobile, home, work, other)</li>
                                    <li>is_primary (true/false or 1/0)</li>
                                    <li>do_not_call (true/false or 1/0)</li>
                                    <li>notes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="upload-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="add-to-sequence-checkbox">
                            Add to sequence after upload
                        </label>
                        <select id="sequence-select" style="display: none;">
                            <option value="">Select a sequence...</option>
                        </select>
                        <div id="sequence-info" class="sequence-info" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="sequence-agent-status">Loading...</div>
                        </div>
                    </div>
                    
                                            <form id="upload-form" enctype="multipart/form-data">
                            <div class="file-upload-area">
                                <input type="file" id="csv-file" name="csvFile" accept=".csv,.xlsx" required>
                                <div class="file-info" id="file-info"></div>
                            </div>
                                                    <div class="upload-actions">
                                <button type="submit" class="btn btn-primary">üìÅ Upload File</button>
                                <button type="button" class="btn btn-secondary" onclick="downloadSampleCSV()">üì• Download Sample</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
            z-index: 3001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .call-detail-section {
            margin-bottom: 25px;
        }

        .call-detail-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .call-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .call-detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .call-detail-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .call-detail-value {
            color: #333;
            font-size: 1.1em;
        }

        .transcript-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .transcript-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .transcript-speaker {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .transcript-text {
            color: #333;
            line-height: 1.4;
        }

        .analysis-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            font-weight: 600;
        }

        .analysis-value {
            font-size: 1.2em;
        }

        @media (max-width: 600px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .call-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Sequence Modal Styles */
        .sequence-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }

        .sequence-entries {
            margin-top: 2rem;
        }

        .sequence-entries h4 {
            margin-bottom: 1rem;
            color: #495057;
        }

        .entries-table {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .entries-header {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 2fr;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            font-weight: 600;
            border-bottom: 1px solid #dee2e6;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 2fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .entry-row:last-child {
            border-bottom: none;
        }

        .entry-cell {
            display: flex;
            align-items: center;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.max_attempts_reached {
            background: #fff3cd;
            color: #856404;
        }

        .selected-items {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .selected-items h4 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .selected-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* Business Hours Styles */
        .business-hours-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .business-hours-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .business-hours-preview {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .preview-text {
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        .validation-message {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .validation-message.error {
            color: #dc3545;
        }

        .validation-message.success {
            color: #28a745;
        }

        .validation-message.warning {
            color: #ffc107;
        }

        /* Sequence Information Styles */
        .sequence-info-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .sequence-info-section h5 {
            margin-bottom: 1rem;
            color: #495057;
            font-size: 1.1rem;
        }

        .sequence-entries-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sequence-entry-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            align-items: center;
        }

        .sequence-name {
            font-weight: 600;
            color: #495057;
        }

        .sequence-status {
            display: flex;
            justify-content: center;
        }

        .sequence-attempts {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .sequence-next-call {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .no-sequence-info {
            padding: 1rem;
            text-align: center;
            color: #6c757d;
            font-style: italic;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
    </style>
</body>
</html> 